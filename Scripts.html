<script>
var currentUser=null,currentView='dashboard',allRecords=[],filteredRecords=[],selectedRecords=new Set(),dropdownOptions={},sortColumn='Date_Last_Touch',sortDirection='desc',currentCallRecord=null,callQueue=[],callQueueIndex=0,researchQueue=[],currentResearchItem=null,bulkMoveLeads=[],bulkMoveSelected=new Set();

// Leads table pagination
var leadsPerPage = 10;
var currentLeadsPage = 1;

// ===========================================
// HELPER: Truncate text with ellipsis
// ===========================================
function truncateText(str, maxLen) {
  if (!str) return '';
  str = String(str);
  return str.length > maxLen ? str.substring(0, maxLen) + '...' : str;
}

// ===========================================
// HELPER: Build cell with tooltip if text is long
// ===========================================
function cellWithTooltip(text, maxLen, className) {
  if (!text) return '<td class="' + (className || '') + '">-</td>';
  var escaped = escapeHtml(String(text));
  var truncated = truncateText(text, maxLen);
  var escapedTruncated = escapeHtml(truncated);

  // Only add tooltip if text was actually truncated
  if (String(text).length > maxLen) {
    return '<td class="' + (className || '') + '" data-tooltip="' + escaped.replace(/"/g, '&quot;') + '">' + escapedTruncated + '</td>';
  }
  return '<td class="' + (className || '') + '">' + escapedTruncated + '</td>';
}

// ===========================================
// HELPER: Format currency with auto-format
// ===========================================
function formatCurrencyInput(input) {
  var value = input.value.replace(/[^0-9.]/g, '');
  if (value === '') {
    input.value = '';
    return;
  }
  var num = parseFloat(value);
  if (!isNaN(num)) {
    input.value = '$' + num.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
  }
}

function parseCurrencyValue(value) {
  if (!value) return 0;
  return parseFloat(String(value).replace(/[$,]/g, '')) || 0;
}

// Loading overlay helper functions
function showLoading(text, showProgress) {
  if (text === undefined) text = 'Processing...';
  if (showProgress === undefined) showProgress = false;

  var overlay = document.getElementById('loadingOverlay');
  var loadingText = document.getElementById('loadingText');
  var progressContainer = document.getElementById('progressContainer');

  if (!overlay) {
    console.warn('Loading overlay not found');
    return;
  }

  if (loadingText) {
    loadingText.textContent = text;
  }

  if (progressContainer) {
    progressContainer.style.display = showProgress ? 'block' : 'none';
  }

  overlay.classList.add('active');
}

function hideLoading() {
  var overlay = document.getElementById('loadingOverlay');
  if (overlay) {
    overlay.classList.remove('active');
  }
}

function updateProgress(current, total, text) {
  var progressCount = document.getElementById('progressCount');
  var progressFill = document.getElementById('progressFill');
  var loadingText = document.getElementById('loadingText');

  if (progressCount) {
    progressCount.textContent = current + ' of ' + total;
  }
  if (progressFill) {
    progressFill.style.width = Math.round((current / total) * 100) + '%';
  }
  if (text && loadingText) {
    loadingText.textContent = text;
  }
}

// Phase 1 Configuration
var LEAD_CAPTURE_FORM_URL = 'https://forms.gle/YOUR_FORM_ID_HERE'; // A5: Update with actual form URL
var DOCUMENTS_DRIVE_URL = 'https://drive.google.com/drive/folders/YOUR_FOLDER_ID_HERE'; // N3: Update with actual folder URL

document.addEventListener('DOMContentLoaded',function(){loadUsers();var s=document.getElementById('searchInput');if(s)s.addEventListener('input',debounce(handleGlobalSearch,300));['filterStatus','filterOwner','filterSource'].forEach(function(id){var el=document.getElementById(id);if(el)el.addEventListener('change',filterAndRenderRecords);});document.querySelectorAll('.date-btn[data-period]').forEach(function(btn){btn.addEventListener('click',function(){setAnalyticsPeriod(this.dataset.period);});});
  // Setup month auto-populate after a short delay to ensure modal is ready
  setTimeout(setupMonthAutoPopulate, 500);
  // Setup currency auto-format for quote fields
  setTimeout(setupCurrencyAutoFormat, 500);
});

// ===========================================
// MONTH AUTO-POPULATE - COMPLETE SOLUTION
// ===========================================
var monthAutoPopulateSetup = false;

function setupMonthAutoPopulate() {
  var dateField = document.getElementById('fieldDateOfEvent');
  if (!dateField) {
    console.log('[MonthAutoFill] Date field not found, retrying in 500ms...');
    setTimeout(setupMonthAutoPopulate, 500);
    return;
  }

  if (monthAutoPopulateSetup) {
    console.log('[MonthAutoFill] Already setup');
    return;
  }

  console.log('[MonthAutoFill] Setting up event listeners...');

  // Remove any existing listeners by cloning
  var newDateField = dateField.cloneNode(true);
  dateField.parentNode.replaceChild(newDateField, dateField);

  // Add fresh listeners
  newDateField.addEventListener('change', function(e) {
    console.log('[MonthAutoFill] CHANGE event fired, value:', this.value);
    autoFillMonthFromDate(this.value);
  });

  newDateField.addEventListener('input', function(e) {
    console.log('[MonthAutoFill] INPUT event fired, value:', this.value);
    autoFillMonthFromDate(this.value);
  });

  monthAutoPopulateSetup = true;
  console.log('[MonthAutoFill] Setup complete!');
}

function autoFillMonthFromDate(dateValue) {
  console.log('[MonthAutoFill] autoFillMonthFromDate called with:', dateValue);

  if (!dateValue) {
    console.log('[MonthAutoFill] No date value, skipping');
    return;
  }

  // Parse the date
  var date;
  if (dateValue instanceof Date) {
    date = dateValue;
  } else if (typeof dateValue === 'string') {
    // Handle YYYY-MM-DD format
    if (dateValue.match(/^\d{4}-\d{2}-\d{2}$/)) {
      var parts = dateValue.split('-');
      date = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]), 12, 0, 0);
    } else if (dateValue.includes('/')) {
      // Handle MM/DD/YYYY or DD/MM/YYYY
      var parts = dateValue.split('/');
      if (parts[2] && parts[2].length === 4) {
        // Assume MM/DD/YYYY
        date = new Date(parseInt(parts[2]), parseInt(parts[0]) - 1, parseInt(parts[1]), 12, 0, 0);
      } else {
        date = new Date(dateValue);
      }
    } else {
      date = new Date(dateValue);
    }
  } else {
    date = new Date(dateValue);
  }

  console.log('[MonthAutoFill] Parsed date:', date, 'Valid:', !isNaN(date.getTime()));

  if (!date || isNaN(date.getTime())) {
    console.log('[MonthAutoFill] Invalid date, skipping');
    return;
  }

  var monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                    'July', 'August', 'September', 'October', 'November', 'December'];
  var monthName = monthNames[date.getMonth()];
  console.log('[MonthAutoFill] Month to set:', monthName);

  // Find and set the month field
  var monthField = document.getElementById('fieldMonthOfEvent');
  if (!monthField) {
    console.error('[MonthAutoFill] Month field not found!');
    return;
  }

  console.log('[MonthAutoFill] Month field found, current value:', monthField.value);
  console.log('[MonthAutoFill] Available options:', Array.from(monthField.options).map(function(o) { return o.value; }));

  // Try to set the value
  monthField.value = monthName;

  // Check if it worked
  if (monthField.value === monthName) {
    console.log('[MonthAutoFill] SUCCESS! Month set to:', monthName);
  } else {
    console.log('[MonthAutoFill] Direct set failed, trying case-insensitive match...');
    // Try case-insensitive match
    for (var i = 0; i < monthField.options.length; i++) {
      if (monthField.options[i].value.toLowerCase() === monthName.toLowerCase()) {
        monthField.selectedIndex = i;
        console.log('[MonthAutoFill] Found match at index:', i, 'Value:', monthField.options[i].value);
        break;
      }
    }
  }

  // Also fill Month_Pitch_Event if empty
  var pitchMonthField = document.getElementById('fieldMonthPitchEvent');
  if (pitchMonthField && !pitchMonthField.value) {
    pitchMonthField.value = monthName;
    console.log('[MonthAutoFill] Also set pitch month to:', monthName);
  }
}

// Auto-populate month when modal opens for existing leads with date but no month
function autoFillMonthOnModalOpen(){
  var dateField = document.getElementById('fieldDateOfEvent');
  var monthField = document.getElementById('fieldMonthOfEvent');

  if(dateField && dateField.value && monthField && !monthField.value){
    console.log('[MonthAutoFill] Modal opened - auto-filling month from existing date');
    handleEventDateChange(dateField.value);
  }
}

// ===========================================
// CURRENCY AUTO-FORMAT - ON BLUR
// ===========================================
var currencyAutoFormatSetup = false;

function setupCurrencyAutoFormat() {
  if (currencyAutoFormatSetup) {
    console.log('[CurrencyFormat] Already setup');
    return;
  }

  // Quote field IDs to add currency formatting
  var quoteFieldIds = ['fieldActiveQuote', 'fieldOldQuote'];
  var fieldsSetup = 0;

  quoteFieldIds.forEach(function(fieldId) {
    var field = document.getElementById(fieldId);
    if (field) {
      // Clone to remove any existing listeners
      var newField = field.cloneNode(true);
      field.parentNode.replaceChild(newField, field);

      // Add blur event listener for formatting
      newField.addEventListener('blur', function() {
        console.log('[CurrencyFormat] Blur event on ' + fieldId + ', value:', this.value);
        formatCurrencyInput(this);
      });

      // Also format on input if user types $ or comma
      newField.addEventListener('input', function(e) {
        // Remove any non-numeric characters except period on the fly
        // But don't format yet - that happens on blur
        var val = this.value;
        // Allow digits, period, and dollar sign (which we'll strip on blur)
        // Just remove truly invalid chars
      });

      console.log('[CurrencyFormat] Added blur listener to ' + fieldId);
      fieldsSetup++;
    } else {
      console.log('[CurrencyFormat] Field not found: ' + fieldId + ', will retry...');
    }
  });

  if (fieldsSetup === quoteFieldIds.length) {
    currencyAutoFormatSetup = true;
    console.log('[CurrencyFormat] Setup complete for all quote fields!');
  } else if (fieldsSetup > 0) {
    currencyAutoFormatSetup = true;
    console.log('[CurrencyFormat] Partial setup complete (' + fieldsSetup + '/' + quoteFieldIds.length + ')');
  } else {
    // Retry if fields not found yet
    console.log('[CurrencyFormat] No fields found, retrying in 500ms...');
    setTimeout(setupCurrencyAutoFormat, 500);
  }
}

// Global search - works from any page
function handleGlobalSearch(){
  var searchInput = document.getElementById('searchInput');
  var searchTerm = searchInput ? searchInput.value.trim() : '';

  // If we're not on a leads view, switch to all leads first
  var leadsViews = ['leads', 'hot', 'followups', 'booked', 'contract', 'parking', 'storage', 'overdue', 'nofollowup', 'stale', 'my', 'dhill'];
  if(searchTerm && leadsViews.indexOf(currentView) === -1){
    // Switch to all leads view with search
    switchView('leads');
    // Wait a moment for the view to load, then apply search
    setTimeout(function(){
      filterAndRenderRecords();
    }, 500);
  } else {
    // Already on a leads view, just filter
    filterAndRenderRecords();
  }
}

// Store all user data for quick lookup
var allUsersData = [];

function loadUsers(){
  // Show loading state
  var selectWrapper = document.getElementById('loginSelectWrapper');
  if(selectWrapper) selectWrapper.classList.add('loading');

  google.script.run
    .withSuccessHandler(function(users){
      console.log('Users loaded:', users);
      allUsersData = users || []; // Store full user data
      var sel = document.getElementById('userSelect');
      if(!sel){
        console.error('userSelect element not found');
        return;
      }
      sel.innerHTML = '<option value="">Select your name...</option>';
      if(users && users.length > 0){
        users.forEach(function(u){
          var opt = document.createElement('option');
          opt.value = u.Name;
          opt.textContent = u.Name;
          opt.dataset.role = u.Role || 'Team Member';
          // Store additional data in dataset for quick access
          opt.dataset.callMethod = u.Call_Method || (u.Role === 'Admin' ? 'phone' : 'dialpad');
          opt.dataset.dialpadEmail = u.Dialpad_Email || '';
          sel.appendChild(opt);
        });
      } else {
        console.warn('No users returned from getUsers()');
      }
      // Hide loading state
      if(selectWrapper) selectWrapper.classList.remove('loading');
    })
    .withFailureHandler(function(err){
      console.error('Failed to load users:', err);
      // Hide loading state on error too
      if(selectWrapper) selectWrapper.classList.remove('loading');
    })
    .getUsers();
}

function handleLogin(){
  var sel=document.getElementById('userSelect');
  if(!sel.value){showToast('Please select your name','error');return;}
  var selectedOpt = sel.options[sel.selectedIndex];
  currentUser={
    name: sel.value,
    role: selectedOpt.dataset.role || 'Team Member',
    callMethod: selectedOpt.dataset.callMethod || 'dialpad',
    dialpadEmail: selectedOpt.dataset.dialpadEmail || ''
  };
  document.getElementById('userName').textContent=currentUser.name;
  document.getElementById('userRole').textContent=currentUser.role;
  document.getElementById('userAvatar').textContent=getInitials(currentUser.name);
  document.getElementById('loginScreen').style.display='none';
  document.getElementById('appContainer').classList.add('active');
  loadDropdownOptions();loadDashboard();refreshSidebarCounts();
}

function logout(){currentUser=null;document.getElementById('loginScreen').style.display='flex';document.getElementById('appContainer').classList.remove('active');}

function loadDropdownOptions(){google.script.run.withSuccessHandler(function(opt){dropdownOptions=opt;populateAllDropdowns();}).withFailureHandler(function(e){console.error(e);}).getDropdownOptions();}

function populateAllDropdowns(){
  console.log('[Dropdowns] populateAllDropdowns called, options:', dropdownOptions);
  console.log('[Dropdowns] Month_of_Event values:', dropdownOptions.Month_of_Event);

  var map={
    'fieldTimeZone':'Time_Zone',
    'fieldTypeOfPhone':'Phone_Type',
    'fieldLeadOwner':'Lead_Owner',
    'fieldCategory':'Category',
    'fieldMonthOfEvent':'Month_of_Event',
    'fieldWhatPitched':'What_Pitched',
    'fieldCompanyState':'State',
    'fieldVenueState':'State',
    'fieldLeadStatus':'Lead_Status',
    'fieldLeadSource':'Lead_Source',
    'fieldMonthPitchEvent':'Month_of_Event',
    'fieldDhillCallList':'Yes_No',
    'fieldDCallList':'Yes_No',
    'fieldCreateMockContract':'Yes_No',
    'fieldQuickCallNotes':'Quick_Call_Notes',
    'fieldAddToBooklist':'Yes_No',
    'fieldAddToPCL':'Yes_No'
  };

  for(var id in map){
    var el=document.getElementById(id);
    var optionKey = map[id];
    if(el && dropdownOptions[optionKey]){
      el.innerHTML='<option value="">Select...</option>'+dropdownOptions[optionKey].map(function(v){
        return'<option value="'+escapeHtml(v)+'">'+escapeHtml(v)+'</option>';
      }).join('');
      console.log('[Dropdowns] Populated', id, 'with', dropdownOptions[optionKey].length, 'options from', optionKey);
    } else {
      console.log('[Dropdowns] Could not populate', id, '- element:', !!el, 'options:', optionKey, dropdownOptions[optionKey]);
    }
  }

  var filters=[['filterStatus','Lead_Status','All Statuses'],['filterOwner','Lead_Owner','All Owners'],['filterSource','Lead_Source','All Sources']];
  filters.forEach(function(f){
    var el=document.getElementById(f[0]);
    if(el&&dropdownOptions[f[1]]){
      el.innerHTML='<option value="">'+f[2]+'</option>'+dropdownOptions[f[1]].map(function(v){
        return'<option value="'+escapeHtml(v)+'">'+escapeHtml(v)+'</option>';
      }).join('');
    }
  });
}

function switchView(view){
  currentView=view;
  selectedRecords.clear();
  updateBulkBar();

  // Update nav items active state
  document.querySelectorAll('.nav-item').forEach(function(n){
    n.classList.toggle('active',n.dataset.view===view);
  });

  // View titles for list views
  var titles={
    dashboard:'Dashboard',
    leads:'All Leads',
    my:'My Leads',
    hot:'Hot Leads',
    followups:"Today's Follow Ups",
    contracts:'Contracts Review',
    dhill:'Dhill Review',
    booked:'Booked Shows',
    clients:'Clients',
    parking:'Parking Lot',
    storage:'Storage',
    research:'Research Queue',
    calls:'Call History',
    eod:'Daily Check-in',
    analytics:'Analytics',
    overdue:'Overdue Follow-ups',
    nofollowup:'No Follow-up Set',
    stale:'Stale Leads (7+ days)',
    contractsFolder:'Contracts Folder'
  };

  // Update list view title if it exists
  var listViewTitle = document.getElementById('listViewTitle');
  if(listViewTitle){
    listViewTitle.textContent = titles[view] || 'Leads';
  }

  // Hide all views first
  document.querySelectorAll('.view').forEach(function(v){
    v.classList.remove('active');
  });

  // Show/hide bulk move button for storage view
  var bulkMoveBtn=document.getElementById('bulkMoveBtn');
  if(bulkMoveBtn){
    bulkMoveBtn.style.display = view==='storage' ? 'inline-flex' : 'none';
  }

  // Show appropriate view and load data
  if(view==='dashboard'){
    document.getElementById('dashboardView').classList.add('active');
    loadDashboard();
  } else if(view==='research'){
    document.getElementById('researchView').classList.add('active');
    loadResearchQueue();
  } else if(view==='eod'){
    document.getElementById('eodView').classList.add('active');
    loadCheckin();
  } else if(view==='calls'){
    document.getElementById('callsView').classList.add('active');
    loadCallHistoryWithSync();
  } else if(view==='analytics'){
    document.getElementById('analyticsView').classList.add('active');
    loadAnalytics();
  } else if(view==='contractsFolder'){
    document.getElementById('contractsFolderView').classList.add('active');
    loadContractsFolder();
  } else if(view==='clients'){
    document.getElementById('clientsView').classList.add('active');
    loadClientsView();
  } else {
    document.getElementById('listView').classList.add('active');
    loadListView(view);
  }
}

var currentDashPeriod = 'week';
var customDateFrom = null;
var customDateTo = null;

function loadDashboard() {
  // Setup performance tab listeners
  setupPerfTabs();

  // Show dashboard loading overlay
  var loadingOverlay = document.getElementById('dashboardLoading');
  if(loadingOverlay) loadingOverlay.classList.add('active');

  // Reset dashboard content opacity
  document.querySelectorAll('.dashboard-content').forEach(function(el){
    el.classList.remove('loaded');
    el.style.opacity = '0';
  });

  google.script.run
    .withSuccessHandler(function(data) {
      renderDashboard(data);
      updateNavBadges(data);

      // Hide loading overlay
      if(loadingOverlay) loadingOverlay.classList.remove('active');

      // Animate dashboard content in with stagger
      setTimeout(function(){
        document.querySelectorAll('.dashboard-content').forEach(function(el, idx){
          setTimeout(function(){
            el.classList.add('loaded');
          }, idx * 100);
        });
      }, 200);
    })
    .withFailureHandler(function(err) {
      console.error('Dashboard error:', err);
      showToast('Error loading dashboard', 'error');

      // Hide loading overlay on error too
      if(loadingOverlay) loadingOverlay.classList.remove('active');

      // Show content anyway
      document.querySelectorAll('.dashboard-content').forEach(function(el){
        el.classList.add('loaded');
      });
    })
    .getDashboardStats(currentUser ? currentUser.name : '');
}

function setupPerfTabs() {
  document.querySelectorAll('.perf-tab').forEach(function(tab) {
    tab.onclick = function() {
      document.querySelectorAll('.perf-tab').forEach(function(t) { t.classList.remove('active'); });
      this.classList.add('active');

      var period = this.dataset.period;

      if (period === 'custom') {
        document.getElementById('dateRangePicker').classList.add('visible');
      } else {
        document.getElementById('dateRangePicker').classList.remove('visible');
        currentDashPeriod = period;
        customDateFrom = null;
        customDateTo = null;
        loadPerformance();
      }
    };
  });
}

function applyCustomDateRange() {
  var from = document.getElementById('dateFrom').value;
  var to = document.getElementById('dateTo').value;

  if (!from || !to) {
    showToast('Please select both dates', 'error');
    return;
  }

  customDateFrom = from;
  customDateTo = to;
  currentDashPeriod = 'custom';
  loadPerformance();
}

function updateNavBadges(s){
  var el;
  el=document.getElementById('navLeadsCount');if(el)el.textContent=s.totalActive||0;
  el=document.getElementById('navHotCount');if(el)el.textContent=s.hotLeads||0;
  el=document.getElementById('navFollowupsCount');if(el)el.textContent=s.todayFollowUps||0;
  el=document.getElementById('navBookedCount');if(el)el.textContent=s.bookedCount||0;
  el=document.getElementById('navClientsCount');if(el)el.textContent=s.clientsCount||0;
  el=document.getElementById('navContractsCount');if(el)el.textContent=s.contractsReview||0;
  el=document.getElementById('navParkingCount');if(el)el.textContent=s.parkingLotCount||0;
  el=document.getElementById('navStorageCount');if(el)el.textContent=s.storageCount||0;
  el=document.getElementById('navMyCount');if(el)el.textContent=s.myLeadsCount||0;
  el=document.getElementById('navDhillCount');if(el)el.textContent=s.dhillCount||0;
  el=document.getElementById('navOverdueCount');if(el)el.textContent=s.overdueFollowups||0;
  el=document.getElementById('navNoFollowupCount');if(el)el.textContent=s.noFollowupSet||0;
  el=document.getElementById('navStaleCount');if(el)el.textContent=s.staleLeads||0;
  var scl=document.getElementById('sidebarContractsLink');if(scl)scl.href=DOCUMENTS_DRIVE_URL;
}

// Refresh all sidebar badge counts - call this after any data change
function refreshSidebarCounts(){
  // Get fresh dashboard stats for sidebar badges
  google.script.run
    .withSuccessHandler(function(stats){
      if(stats) updateNavBadges(stats);
    })
    .withFailureHandler(function(e){
      console.error('Error refreshing sidebar counts:', e);
    })
    .getDashboardStats(currentUser ? currentUser.name : '', 'week');

  // Also refresh contracts folder count
  google.script.run
    .withSuccessHandler(function(result){
      var count = (result && result.contracts) ? result.contracts.length : 0;
      var navEl = document.getElementById('navContractsFolderCount');
      if(navEl) navEl.textContent = count;
    })
    .withFailureHandler(function(e){
      console.error('Error refreshing contracts count:', e);
    })
    .getContractsList();

  // Refresh research count
  google.script.run
    .withSuccessHandler(function(items){
      var count = items ? items.length : 0;
      var navEl = document.getElementById('navResearchCount');
      if(navEl) navEl.textContent = count;
    })
    .withFailureHandler(function(e){
      console.error('Error refreshing research count:', e);
    })
    .getResearchQueue();
}

function renderDashboard(data) {
  if (!data) data = {};

  // Parse values
  var pipelineNum = parseFloat(String(data.pipelineValue || '0').replace(/[^0-9.-]/g, '')) || 0;
  var hotVal = parseFloat(String(data.hotValue || '0').replace(/[^0-9.-]/g, '')) || 0;
  // Use totalBookedValue (all time) instead of bookedMTD
  var bookedVal = parseFloat(String(data.totalBookedValue || data.bookedMTD || '0').replace(/[^0-9.-]/g, '')) || 0;
  var riskVal = parseFloat(String(data.overdueValue || '0').replace(/[^0-9.-]/g, '')) +
                parseFloat(String(data.staleValue || '0').replace(/[^0-9.-]/g, '')) +
                parseFloat(String(data.noFollowupValue || '0').replace(/[^0-9.-]/g, ''));
  var riskCount = (data.overdueFollowups || 0) + (data.staleLeads || 0) + (data.noFollowupSet || 0);

  // Hero Stats with animated counters
  animateNum('heroPipeline', 0, pipelineNum, 1000, true);
  var el = document.getElementById('heroPipelineSub');
  if (el) el.textContent = (data.totalActive || 0) + ' active leads';
  el = document.getElementById('heroPipelineCount');
  if (el) el.textContent = (data.totalActive || 0) + ' leads';

  animateNum('heroHot', 0, hotVal, 1000, true);
  el = document.getElementById('heroHotSub');
  if (el) el.textContent = (data.hotLeads || 0) + ' hot leads';
  el = document.getElementById('heroHotCount');
  if (el) el.textContent = (data.hotLeads || 0) + ' hot';

  animateNum('heroBooked', 0, bookedVal, 1000, true);
  // Use bookedCount (total) instead of bookedCountMTD
  var bookedDeals = data.bookedFunnelCount || data.bookedCount || data.bookedCountMTD || 0;
  el = document.getElementById('heroBookedSub');
  if (el) el.textContent = bookedDeals + ' deals';
  el = document.getElementById('heroBookedCount');
  if (el) el.textContent = bookedDeals + ' deals';

  animateNum('heroRisk', 0, riskVal, 1000, true);
  el = document.getElementById('heroRiskSub');
  if (el) el.textContent = riskCount + ' leads need attention';
  el = document.getElementById('heroRiskCount');
  if (el) el.textContent = riskCount + ' leads';

  // Funnel
  renderFunnel(data);

  // Attention
  var overdueCount = data.overdueFollowups || 0;
  var staleCount = data.staleLeads || 0;
  var noFollowCount = data.noFollowupSet || 0;
  var hotColdCount = data.hotGoingCold || 0;
  var attTotal = overdueCount + staleCount + noFollowCount + hotColdCount;

  el = document.getElementById('attOverdue');
  if (el) el.textContent = overdueCount;
  el = document.getElementById('attStale');
  if (el) el.textContent = staleCount;
  el = document.getElementById('attNoFollow');
  if (el) el.textContent = noFollowCount;
  el = document.getElementById('attHotCold');
  if (el) el.textContent = hotColdCount;
  el = document.getElementById('attTotal');
  if (el) el.textContent = attTotal;

  // Load shows and sources
  loadShows();
  loadSources(data);

  // Load performance section
  loadPerformance();
}

function renderFunnel(data) {
  if (!data) return;

  // Get counts by status (Cold, Warm, Hot, Contract Lead, Booked)
  var cold = data.coldCount || 0;
  var warm = data.warmCount || 0;
  var hot = data.hotCount || 0;
  var contract = data.contractCount || 0;
  var booked = data.bookedFunnelCount || data.bookedCount || 0;

  // Get values (parse if string with $ sign)
  var coldVal = data.coldValue || 0;
  var warmVal = data.warmFunnelValue || data.warmValue || 0;
  var hotVal = data.hotFunnelValue || 0;
  var contractVal = data.contractValue || 0;
  var bookedVal = data.bookedFunnelValue || 0;

  // Parse string values if needed
  if (typeof warmVal === 'string') warmVal = parseFloat(warmVal.replace(/[^0-9.-]/g, '')) || 0;
  if (typeof hotVal === 'string') hotVal = parseFloat(hotVal.replace(/[^0-9.-]/g, '')) || 0;

  var maxCount = Math.max(cold, warm, hot, contract, booked, 1);

  // Animate bars with delay
  setTimeout(function() {
    var el;
    el = document.getElementById('funnelBarCold');
    if (el) el.style.width = ((cold / maxCount) * 100) + '%';

    el = document.getElementById('funnelBarWarm');
    if (el) el.style.width = ((warm / maxCount) * 100) + '%';

    el = document.getElementById('funnelBarHot');
    if (el) el.style.width = ((hot / maxCount) * 100) + '%';

    el = document.getElementById('funnelBarContract');
    if (el) el.style.width = ((contract / maxCount) * 100) + '%';

    el = document.getElementById('funnelBarBooked');
    if (el) el.style.width = ((booked / maxCount) * 100) + '%';
  }, 300);

  // Set counts
  var el;
  el = document.getElementById('funnelCountCold');
  if (el) el.textContent = cold;

  el = document.getElementById('funnelCountWarm');
  if (el) el.textContent = warm;

  el = document.getElementById('funnelCountHot');
  if (el) el.textContent = hot;

  el = document.getElementById('funnelCountContract');
  if (el) el.textContent = contract;

  el = document.getElementById('funnelCountBooked');
  if (el) el.textContent = booked;

  // Set values
  el = document.getElementById('funnelValCold');
  if (el) el.textContent = '$' + coldVal.toLocaleString();

  el = document.getElementById('funnelValWarm');
  if (el) el.textContent = '$' + warmVal.toLocaleString();

  el = document.getElementById('funnelValHot');
  if (el) el.textContent = '$' + hotVal.toLocaleString();

  el = document.getElementById('funnelValContract');
  if (el) el.textContent = '$' + contractVal.toLocaleString();

  el = document.getElementById('funnelValBooked');
  if (el) el.textContent = '$' + bookedVal.toLocaleString();
}

function loadShows() {
  console.log('loadShows() called');
  google.script.run
    .withSuccessHandler(function(shows) {
      console.log('getUpcomingShows returned:', shows);
      console.log('Shows count:', shows ? shows.length : 0);

      var listEl = document.getElementById('dashShows');
      var totalEl = document.getElementById('showsTotal');

      if (!shows || !shows.length) {
        console.log('No shows - displaying empty message');
        if (listEl) listEl.innerHTML = '<div class="empty-shows">No shows in next 30 days</div>';
        if (totalEl) totalEl.textContent = '$0';
        return;
      }

      var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      var totalRev = 0;

      if (listEl) {
        listEl.innerHTML = shows.slice(0, 5).map(function(show) {
          var d = null;
          if (show.eventDate) {
            d = new Date(show.eventDate);
            if (isNaN(d.getTime())) d = null;
          }
          var val = parseFloat(String(show.Active_Quote || '0').replace(/[^0-9.-]/g, '')) || 0;
          totalRev += val;
          return '<div class="show-row">' +
            '<div class="show-date"><span class="month">' + (d ? months[d.getMonth()] : '---') + '</span><span class="day">' + (d ? d.getDate() : '--') + '</span></div>' +
            '<div class="show-info"><div class="show-name">' + escapeHtml(show.Event_Name || show.Company_Name || 'Show') + '</div><div class="show-loc">' + escapeHtml(show.Venue_City || show.Company_City || '') + '</div></div>' +
            '<div class="show-amt">$' + val.toLocaleString() + '</div>' +
          '</div>';
        }).join('');
      }

      if (totalEl) totalEl.textContent = '$' + totalRev.toLocaleString();
    })
    .withFailureHandler(function(err) {
      console.error('getUpcomingShows FAILED:', err);
      var listEl = document.getElementById('dashShows');
      if (listEl) listEl.innerHTML = '<div class="empty-shows">Could not load shows</div>';
    })
    .getUpcomingShows(currentUser ? currentUser.name : '');
}

function loadSources(data) {
  var sources = data.leadSources || [];
  var listEl = document.getElementById('dashSources');
  if (!listEl) return;

  if (!sources.length) {
    listEl.innerHTML = '<div class="empty-shows">No source data</div>';
    return;
  }

  var max = Math.max.apply(null, sources.map(function(s) { return s.count || 0; })) || 1;

  listEl.innerHTML = sources.slice(0, 6).map(function(src) {
    var pct = ((src.count || 0) / max) * 100;
    return '<div class="source-row">' +
      '<span class="source-name">' + escapeHtml(src.name || 'Unknown') + '</span>' +
      '<div class="source-track"><div class="source-bar" style="width:' + pct + '%"></div></div>' +
      '<span class="source-val">' + (src.count || 0) + '</span>' +
    '</div>';
  }).join('');
}

function loadPerformance() {
  var period = currentDashPeriod;
  var dateFrom = customDateFrom;
  var dateTo = customDateTo;

  // Show loading state for team table while fetching new data
  showTeamTableLoading();

  google.script.run
    .withSuccessHandler(function(data) {
      renderPerformance(data);
    })
    .withFailureHandler(function(err) {
      console.error('Performance error:', err);
    })
    .getPerformanceStats(period, dateFrom, dateTo);

  // Load team leaderboard
  google.script.run
    .withSuccessHandler(function(team) {
      renderTeamTable(team);
    })
    .withFailureHandler(function(err) {
      console.error('Team error:', err);
      var tbody = document.getElementById('teamTableBody');
      if (tbody) tbody.innerHTML = '<div class="team-loading">Could not load team data</div>';
    })
    .getTeamPerformance(period, dateFrom, dateTo);
}

function renderPerformance(data) {
  if (!data) data = {};

  var el = document.getElementById('perfCalls');
  if (el) el.textContent = data.calls || 0;

  el = document.getElementById('perfConvos');
  if (el) el.textContent = data.conversations || 0;

  el = document.getElementById('perfEmails');
  if (el) el.textContent = data.emails || 0;

  el = document.getElementById('perfDeals');
  if (el) el.textContent = data.deals || 0;

  el = document.getElementById('perfRevenue');
  if (el) el.textContent = '$' + (data.revenue || 0).toLocaleString();
}

// Pagination state for team table
var teamTablePage = 1;
var teamTablePerPage = 10; // Show all team members on one page (no pagination needed)
var teamTableData = [];

function showTeamTableLoading() {
  var tbody = document.getElementById('teamTableBody');
  if (tbody) {
    tbody.innerHTML = '<div class="team-loading-simple">' +
      '<div class="mini-spinner"></div>' +
      '<span>Loading...</span>' +
    '</div>';
  }
}

function renderTeamTable(team) {
  var tbody = document.getElementById('teamTableBody');
  if (!tbody) return;

  if (!team || !team.length) {
    tbody.innerHTML = '<div class="team-loading">No team data available</div>';
    renderTeamPagination(0);
    return;
  }

  // Store data for pagination
  teamTableData = team;
  teamTablePage = 1;

  renderTeamTablePage();
}

function renderTeamTablePage() {
  var tbody = document.getElementById('teamTableBody');
  if (!tbody || !teamTableData.length) return;

  var colors = ['#6366f1', '#8b5cf6', '#ec4899', '#f59e0b', '#22c55e', '#06b6d4'];
  var totalPages = Math.ceil(teamTableData.length / teamTablePerPage);
  var startIdx = (teamTablePage - 1) * teamTablePerPage;
  var endIdx = Math.min(startIdx + teamTablePerPage, teamTableData.length);
  var pageData = teamTableData.slice(startIdx, endIdx);

  // SCORE Formula: calls*1 + conversations*3 + emails*1 + upgrades*5 + deals*20 + bookedValue/100
  // Quality Score: Average AI score from OpenAI grading (from Dialpad_Calls sheet)
  tbody.innerHTML = pageData.map(function(m, idx) {
    var i = startIdx + idx; // Original index for ranking
    var rankClass = i === 0 ? 'rank-1' : i === 1 ? 'rank-2' : i === 2 ? 'rank-3' : 'rank-other';
    var rowClass = i === 0 ? 'team-row top-performer' : 'team-row';
    var initials = (m.name || 'U').split(' ').map(function(n) { return n[0]; }).join('').substring(0, 2).toUpperCase();

    // Quality score display: show "N/A" if null, otherwise show the score with %
    var qualityDisplay = (m.qualityScore === null || m.qualityScore === undefined) ? 'N/A' : m.qualityScore + '%';
    var qualityColor = (m.qualityScore === null || m.qualityScore === undefined) ? 'var(--text-muted)' : '#06b6d4';

    return '<div class="' + rowClass + '">' +
      '<div class="team-rank-badge ' + rankClass + '">' + (i + 1) + '</div>' +
      '<div class="team-member">' +
        '<div class="team-avatar" style="background:' + colors[i % colors.length] + '">' + initials + '</div>' +
        '<span class="team-name">' + escapeHtml(m.name || 'Unknown') + '</span>' +
      '</div>' +
      '<span class="team-stat">' + (m.calls || 0) + '</span>' +
      '<span class="team-stat">' + (m.conversations || 0) + '</span>' +
      '<span class="team-stat">' + (m.emails || 0) + '</span>' +
      '<span class="team-stat">' + (m.upgrades || 0) + '</span>' +
      '<span class="team-stat highlight">' + (m.deals || 0) + '</span>' +
      '<span class="team-stat money">$' + (m.bookedValue || 0).toLocaleString() + '</span>' +
      '<span class="team-stat">$' + (m.pipelineValue || 0).toLocaleString() + '</span>' +
      '<span class="team-stat" style="color:' + qualityColor + ';">' + qualityDisplay + '</span>' +
      '<span class="team-score">' + (m.score || 0) + '</span>' +
    '</div>';
  }).join('');

  renderTeamPagination(totalPages);
}

function renderTeamPagination(totalPages) {
  var paginationEl = document.getElementById('teamPagination');
  if (!paginationEl) return;

  if (totalPages <= 1) {
    paginationEl.innerHTML = '';
    return;
  }

  var html = '<button class="page-btn" onclick="changeTeamPage(-1)" ' + (teamTablePage <= 1 ? 'disabled' : '') + '>' +
    '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15,18 9,12 15,6"/></svg>' +
  '</button>';

  for (var p = 1; p <= totalPages; p++) {
    html += '<button class="page-btn ' + (p === teamTablePage ? 'active' : '') + '" onclick="goToTeamPage(' + p + ')">' + p + '</button>';
  }

  html += '<button class="page-btn" onclick="changeTeamPage(1)" ' + (teamTablePage >= totalPages ? 'disabled' : '') + '>' +
    '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9,18 15,12 9,6"/></svg>' +
  '</button>';

  paginationEl.innerHTML = html;
}

function changeTeamPage(delta) {
  var totalPages = Math.ceil(teamTableData.length / teamTablePerPage);
  var newPage = teamTablePage + delta;
  if (newPage >= 1 && newPage <= totalPages) {
    teamTablePage = newPage;
    renderTeamTablePage();
  }
}

function goToTeamPage(page) {
  teamTablePage = page;
  renderTeamTablePage();
}

function animateNum(id, start, end, duration, isCurrency) {
  var el = document.getElementById(id);
  if (!el) return;

  var startTime = null;
  var easeOut = function(t) { return 1 - Math.pow(1 - t, 3); };
  var step = function(timestamp) {
    if (!startTime) startTime = timestamp;
    var progress = Math.min((timestamp - startTime) / duration, 1);
    var easedProgress = easeOut(progress);
    var value = Math.floor(easedProgress * (end - start) + start);
    el.textContent = isCurrency ? '$' + value.toLocaleString() : value.toLocaleString();
    if (progress < 1) {
      window.requestAnimationFrame(step);
    }
  };
  window.requestAnimationFrame(step);
}

function navTo(view) {
  switchView(view);
}

function goToView(view){
  switchView(view);
}

function loadTeamPerformance(){var period=document.getElementById('perfPeriod').value||'week';google.script.run.withSuccessHandler(function(data){renderTeamPerformance(data);}).withFailureHandler(function(e){console.error(e);renderTeamPerformance([]);}).getTeamPerformance(period);}

function renderTeamPerformance(data){var c=document.getElementById('teamPerformance');if(!data||!data.length){c.innerHTML='<div class="perf-empty">No performance data for this period</div>';return;}c.innerHTML='<table class="perf-table"><thead><tr><th>Team Member</th><th>Calls</th><th>Conversations</th><th>Upgrades</th><th>Contracts</th><th>Avg Score</th></tr></thead><tbody>'+data.map(function(m){return'<tr><td><div class="perf-member"><div class="perf-avatar">'+getInitials(m.name)+'</div><span>'+escapeHtml(m.name)+'</span></div></td><td>'+(m.calls||0)+'</td><td>'+(m.conversations||0)+'</td><td>'+(m.upgrades||0)+'</td><td>'+(m.contracts||0)+'</td><td>'+(m.avgScore?m.avgScore.toFixed(1):'-')+'</td></tr>';}).join('')+'</tbody></table>';}

function loadEODReport(){var d=new Date();document.getElementById('checkinDate').textContent=d.toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});google.script.run.withSuccessHandler(function(m){document.getElementById('eodCalls').textContent=m.Calls_Made||0;document.getElementById('eodConversations').textContent=m.Conversations||0;document.getElementById('eodFollowups').textContent=m.Followups_Sent||0;document.getElementById('eodUpgrades').textContent=m.Leads_Upgraded||0;document.getElementById('eodContracts').textContent=m.Contracts_Generated||0;if(m.Training_Time)document.getElementById('eodTraining').value=m.Training_Time;if(m.Roleplay_Time)document.getElementById('eodRoleplay').value=m.Roleplay_Time;if(m.Call_Score_Self)document.getElementById('eodScore').value=m.Call_Score_Self;if(m.Roadblocks)document.getElementById('eodRoadblocks').value=m.Roadblocks;if(m.Special_Notes)document.getElementById('eodNotes').value=m.Special_Notes;}).withFailureHandler(function(e){console.error(e);}).getTodayMetrics(currentUser?currentUser.name:'');}

function submitEOD(){var data={Training_Time:document.getElementById('eodTraining').value,Roleplay_Time:document.getElementById('eodRoleplay').value,Call_Score_Self:document.getElementById('eodScore').value,Roadblocks:document.getElementById('eodRoadblocks').value,Special_Notes:document.getElementById('eodNotes').value};showLoading('Submitting EOD report...');google.script.run.withSuccessHandler(function(r){hideLoading();if(r.success)showToast('EOD report submitted!','success');else showToast('Error: '+(r.error||'Unknown'),'error');}).withFailureHandler(function(e){hideLoading();showToast('Failed to submit','error');console.error(e);}).submitEODReport(data,currentUser?currentUser.name:'');}

function loadListView(view){showLoading('Loading leads...');google.script.run.withSuccessHandler(function(records){hideLoading();allRecords=records||[];filterAndRenderRecords();}).withFailureHandler(function(e){hideLoading();console.error(e);allRecords=[];filterAndRenderRecords();}).getLeads(view,currentUser?currentUser.name:'');}

function filterAndRenderRecords(){var search=(document.getElementById('searchInput').value||'').toLowerCase();var status=document.getElementById('filterStatus').value;var owner=document.getElementById('filterOwner').value;var source=document.getElementById('filterSource').value;filteredRecords=allRecords.filter(function(r){if(status&&r.Lead_Status!==status)return false;if(owner&&r.Lead_Owner!==owner)return false;if(source&&r.Lead_Source!==source)return false;if(search){var s=[r.Contact_Person,r.Email,r.Event_Name,r.Company_Name,r.Phone_Number].join(' ').toLowerCase();if(s.indexOf(search)===-1)return false;}return true;});currentLeadsPage=1;sortRecords();renderTable();}

function sortRecords(){
  filteredRecords.sort(function(a,b){
    var aV=a[sortColumn]||'';
    var bV=b[sortColumn]||'';

    // Handle quotes (money)
    if(sortColumn==='Active_Quote'||sortColumn==='Old_Quote'){
      aV=parseFloat(String(aV).replace(/[^0-9.-]/g,''))||0;
      bV=parseFloat(String(bV).replace(/[^0-9.-]/g,''))||0;
    }

    // Handle dates
    if(sortColumn.indexOf('Date')!==-1){
      aV=aV?new Date(aV).getTime():0;
      bV=bV?new Date(bV).getTime():0;
    }

    if(aV<bV)return sortDirection==='asc'?-1:1;
    if(aV>bV)return sortDirection==='asc'?1:-1;
    return 0;
  });
}

function sortBy(col){
  if(sortColumn===col) {
    sortDirection=sortDirection==='asc'?'desc':'asc';
  } else {
    sortColumn=col;
    sortDirection='desc';
  }
  sortRecords();
  renderTable();
  updateSortIcons();
}

function updateSortIcons() {
  // Reset all sort icons to neutral ↕ and remove sorted classes
  document.querySelectorAll('.data-table th .sort-icon').forEach(function(icon) {
    icon.textContent = '↕';
    icon.parentElement.classList.remove('sorted', 'asc', 'desc');
  });
  // Set current sort icon with direction
  if (sortColumn) {
    var icon = document.getElementById('sort-' + sortColumn);
    if (icon) {
      icon.textContent = sortDirection === 'asc' ? '↑' : '↓';
      icon.parentElement.classList.add('sorted', sortDirection);
    }
  }
  // Show/hide reset button based on active sort
  var resetBtn = document.getElementById('sortResetBtn');
  if (resetBtn) {
    resetBtn.style.display = sortColumn ? 'inline-flex' : 'none';
  }
}

// Reset sort to default (by Last Touch DESC)
function resetSort() {
  sortColumn = 'Date_Last_Touch';
  sortDirection = 'desc';
  sortRecords();
  renderTable();
  updateSortIcons();
  // Hide reset button after reset
  var resetBtn = document.getElementById('sortResetBtn');
  if (resetBtn) resetBtn.style.display = 'none';
  showToast('Sort reset to default', 'success');
}

function renderTable(){
  var tbody=document.getElementById('leadsTableBody');
  var total = filteredRecords.length;
  document.getElementById('listCount').textContent=total+' leads';

  if(!total){
    tbody.innerHTML='<tr><td colspan="10" style="text-align:center;padding:40px;color:var(--text-muted);">No leads found</td></tr>';
    renderLeadsPagination(0);
    return;
  }

  // Pagination calculations
  var totalPages = Math.ceil(total / leadsPerPage);
  if (currentLeadsPage > totalPages) currentLeadsPage = 1;
  var start = (currentLeadsPage - 1) * leadsPerPage;
  var end = Math.min(start + leadsPerPage, total);
  var pageRecords = filteredRecords.slice(start, end);

  tbody.innerHTML=pageRecords.map(function(r){
    var chk=selectedRecords.has(r.rowIndex)?'checked':'';

    // Build badges for Contact cell - simple dark gray style (no color coding)
    var badges = '';
    if(r.daysSinceTouch!==null&&r.daysSinceTouch!==undefined){
      badges += '<span class="badge-days">'+r.daysSinceTouch+'d ago</span>';
    }
    if(r.followupOverdue){
      badges += '<span class="badge-overdue">OVERDUE</span>';
    }
    if(!r.followupOverdue&&r.noFollowupSet){
      badges += '<span class="badge-no-followup">No follow-up</span>';
    }
    var badgesHtml = badges ? '<div class="lead-badges">'+badges+'</div>' : '';

    // Build location string (City, State)
    var locationStr = (r.Venue_City || r.Company_City || '');
    if(r.Venue_State || r.Company_State) {
      locationStr += (locationStr ? ', ' : '') + (r.Venue_State || r.Company_State);
    }

    // Format event date for display (e.g., "Feb 12, 2026")
    var eventDateDisplay = formatDateLong(r.Date_of_Event);

    // Build table row - 10 columns: checkbox, contact, event, event date, location, status, quote, source, owner, actions
    var row = '<tr onclick="openLead('+r.rowIndex+')">';

    // Checkbox
    row += '<td class="col-checkbox" onclick="event.stopPropagation()"><input type="checkbox" '+chk+' onchange="toggleSelect('+r.rowIndex+',this.checked)"></td>';

    // CONTACT - Two-line: Name (bold) + Email (muted) + Badges (inline)
    row += '<td class="col-contact">';
    row += '<div class="lead-row-content">';
    row += '<div class="lead-avatar">'+getInitials(r.Contact_Person||'U')+'</div>';
    row += '<div class="cell-two-line">';
    row += '<span class="cell-primary">'+escapeHtml(r.Contact_Person||'Unknown')+'</span>';
    row += '<span class="cell-secondary">'+escapeHtml(r.Email||'-')+'</span>';
    row += badgesHtml;
    row += '</div></div></td>';

    // EVENT - Just the event name (left aligned, no date below)
    row += '<td class="col-event">'+escapeHtml(r.Event_Name||'-')+'</td>';

    // EVENT DATE - Separate column (center aligned)
    row += '<td class="col-event-date">'+eventDateDisplay+'</td>';

    // Location - can wrap naturally
    row += '<td class="col-location">'+escapeHtml(locationStr||'-')+'</td>';

    // Status
    row += '<td class="col-status"><span class="status status-'+getStatusClass(r.Lead_Status)+'">'+escapeHtml(r.Lead_Status||'-')+'</span></td>';

    // Quote
    row += '<td class="col-quote">'+formatCurrency(r.Active_Quote)+'</td>';

    // Source
    row += '<td class="col-source">'+escapeHtml(r.Lead_Source||'-')+'</td>';

    // Owner
    row += '<td class="col-owner">'+escapeHtml(r.Lead_Owner||'-')+'</td>';

    // Actions - Call and Email buttons
    row += '<td class="col-actions" onclick="event.stopPropagation()"><div class="row-actions">';
    row += '<button class="btn-icon" title="Call" onclick="quickCall('+r.rowIndex+')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg></button>';
    row += '<button class="btn-icon" title="Email" onclick="quickEmail('+r.rowIndex+')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></button>';
    row += '</div></td></tr>';

    return row;
  }).join('');

  renderLeadsPagination(totalPages);
}

// Leads pagination functions
function renderLeadsPagination(totalPages) {
  var paginationEl = document.getElementById('leadsPagination');
  if (!paginationEl) return;

  if (totalPages <= 1) {
    paginationEl.innerHTML = '';
    return;
  }

  var total = filteredRecords.length;
  var start = (currentLeadsPage - 1) * leadsPerPage + 1;
  var end = Math.min(currentLeadsPage * leadsPerPage, total);

  var html = '<div class="pagination-info">Showing ' + start + '-' + end + ' of ' + total + ' leads</div>';
  html += '<div class="pagination-controls">';
  html += '<button class="pagination-btn prev" onclick="prevLeadsPage()" ' + (currentLeadsPage <= 1 ? 'disabled' : '') + '>' +
    '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>' +
  '</button>';

  html += '<div class="pagination-pages">';
  var startPage = Math.max(1, currentLeadsPage - 2);
  var endPage = Math.min(totalPages, startPage + 4);
  for (var p = startPage; p <= endPage; p++) {
    html += '<button class="pagination-page' + (p === currentLeadsPage ? ' active' : '') + '" onclick="goToLeadsPage(' + p + ')">' + p + '</button>';
  }
  html += '</div>';

  html += '<button class="pagination-btn next" onclick="nextLeadsPage()" ' + (currentLeadsPage >= totalPages ? 'disabled' : '') + '>' +
    '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>' +
  '</button>';
  html += '</div>';

  paginationEl.innerHTML = html;
}

function goToLeadsPage(page) {
  currentLeadsPage = page;
  renderTable();
}

function prevLeadsPage() {
  if (currentLeadsPage > 1) {
    currentLeadsPage--;
    renderTable();
  }
}

function nextLeadsPage() {
  var totalPages = Math.ceil(filteredRecords.length / leadsPerPage);
  if (currentLeadsPage < totalPages) {
    currentLeadsPage++;
    renderTable();
  }
}

// ========== CLIENTS VIEW FUNCTIONS ==========
var allClients = [];
var filteredClients = [];
var clientsSortColumn = 'lastBooked';
var clientsSortDirection = 'desc';
var clientsPerPage = 20;
var currentClientsPage = 1;

function loadClientsView() {
  showLoading('Loading clients...');
  google.script.run
    .withSuccessHandler(function(records) {
      hideLoading();
      allClients = processClientsData(records || []);
      filterClients();
    })
    .withFailureHandler(function(e) {
      hideLoading();
      console.error(e);
      allClients = [];
      filterClients();
    })
    .getLeads('clients', currentUser ? currentUser.name : '');
}

function processClientsData(clients) {
  // Group by email to count repeat bookings
  var clientMap = new Map();

  clients.forEach(function(client) {
    var email = client.Email || client.Contact_Person;
    if (clientMap.has(email)) {
      var existing = clientMap.get(email);
      existing.showsBooked++;
      // Keep the most recent booking
      var existingDate = new Date(existing.lastBooked);
      var newDate = new Date(client.Date_of_Event);
      if (newDate > existingDate) {
        existing.lastBooked = client.Date_of_Event;
        existing.lastEvent = client.Event_Name;
        existing.lastAmount = client.Active_Quote;
        existing.lastLocation = (client.Company_City || client.Venue_City || '') +
          (client.Company_State || client.Venue_State ? ', ' + (client.Company_State || client.Venue_State) : '');
        existing.lastEventDate = client.Date_of_Event;
      }
    } else {
      clientMap.set(email, {
        name: client.Contact_Person,
        email: client.Email,
        phone: client.Phone_Number,
        company: client.Company_Name,
        lastEvent: client.Event_Name,
        lastEventDate: client.Date_of_Event,
        lastAmount: client.Active_Quote,
        lastLocation: (client.Company_City || client.Venue_City || '') +
          (client.Company_State || client.Venue_State ? ', ' + (client.Company_State || client.Venue_State) : ''),
        lastBooked: client.Date_of_Event,
        showsBooked: 1,
        recordId: client.Record_ID,
        rowIndex: client.rowIndex
      });
    }
  });

  // Convert to array and sort by last booked (most recent first)
  var uniqueClients = Array.from(clientMap.values())
    .sort(function(a, b) { return new Date(b.lastBooked) - new Date(a.lastBooked); });

  return uniqueClients;
}

function filterClients() {
  var search = (document.getElementById('clientsSearchInput').value || '').toLowerCase();
  filteredClients = allClients.filter(function(c) {
    if (search) {
      var s = [c.name, c.email, c.lastEvent, c.company, c.phone, c.lastLocation].join(' ').toLowerCase();
      if (s.indexOf(search) === -1) return false;
    }
    return true;
  });
  currentClientsPage = 1;
  sortClients();
  renderClientsTable();
}

function sortClientsBy(col) {
  if (clientsSortColumn === col) {
    clientsSortDirection = clientsSortDirection === 'asc' ? 'desc' : 'asc';
  } else {
    clientsSortColumn = col;
    clientsSortDirection = 'desc';
  }
  sortClients();
  renderClientsTable();
}

function sortClients() {
  filteredClients.sort(function(a, b) {
    var aV = a[clientsSortColumn] || '';
    var bV = b[clientsSortColumn] || '';

    if (clientsSortColumn === 'lastAmount') {
      aV = parseFloat(String(aV).replace(/[^0-9.-]/g, '')) || 0;
      bV = parseFloat(String(bV).replace(/[^0-9.-]/g, '')) || 0;
    }
    if (clientsSortColumn === 'showsBooked') {
      aV = parseInt(aV) || 0;
      bV = parseInt(bV) || 0;
    }
    if (clientsSortColumn === 'lastBooked' || clientsSortColumn === 'lastEventDate') {
      aV = new Date(aV) || new Date(0);
      bV = new Date(bV) || new Date(0);
    }

    if (aV < bV) return clientsSortDirection === 'asc' ? -1 : 1;
    if (aV > bV) return clientsSortDirection === 'asc' ? 1 : -1;
    return 0;
  });
}

function renderClientsTable() {
  var tbody = document.getElementById('clientsTableBody');
  var total = filteredClients.length;
  document.getElementById('clientsCount').textContent = total + ' clients';

  if (!total) {
    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:40px;color:var(--text-muted);">No clients found</td></tr>';
    renderClientsPagination(0);
    return;
  }

  var totalPages = Math.ceil(total / clientsPerPage);
  if (currentClientsPage > totalPages) currentClientsPage = 1;
  var start = (currentClientsPage - 1) * clientsPerPage;
  var end = Math.min(start + clientsPerPage, total);
  var pageClients = filteredClients.slice(start, end);

  tbody.innerHTML = pageClients.map(function(c) {
    var showsBadgeClass = c.showsBooked >= 3 ? 'gold' : c.showsBooked >= 2 ? 'silver' : 'default';

    // Build client row with proper column classes
    return '<tr onclick="viewClient(\'' + c.rowIndex + '\')">' +
      // Client Name - Two-line: Name + Email
      '<td class="col-client-name"><div class="client-cell"><div class="avatar">' + getInitials(c.name || 'U') + '</div>' +
        '<div class="cell-two-line"><span class="cell-primary">' + escapeHtml(c.name || 'Unknown') + '</span>' +
        '<span class="cell-secondary">' + escapeHtml(c.email || '-') + '</span></div></div></td>' +
      // Last Event - event name only
      '<td class="col-last-event">' + escapeHtml(c.lastEvent || '-') + '</td>' +
      // Event Date
      '<td class="col-event-date">' + formatDateLong(c.lastEventDate) + '</td>' +
      // Amount Paid
      '<td class="col-amount-paid">' + formatCurrency(c.lastAmount) + '</td>' +
      // Location
      '<td class="col-location">' + escapeHtml(c.lastLocation || '-') + '</td>' +
      // Shows Booked
      '<td class="col-shows-booked"><span class="shows-badge ' + showsBadgeClass + '">' + c.showsBooked + ' ' + (c.showsBooked === 1 ? 'show' : 'shows') + '</span></td>' +
      // Last Booked
      '<td class="col-last-booked">' + formatDateLong(c.lastBooked) + '</td>' +
      // Actions
      '<td class="col-actions" onclick="event.stopPropagation()"><div class="row-actions">' +
        '<button class="btn-icon" title="View" onclick="viewClient(\'' + c.rowIndex + '\')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>' +
        '<button class="btn-icon btn-rebook" title="Rebook" onclick="rebookClient(\'' + escapeHtml(c.email) + '\', \'' + escapeHtml(c.name) + '\')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg></button>' +
        '<button class="btn-icon" title="Email" onclick="quickEmailClient(\'' + escapeHtml(c.email) + '\', \'' + escapeHtml(c.name) + '\')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M22 6l-10 7L2 6"/></svg></button>' +
      '</div></td></tr>';
  }).join('');

  renderClientsPagination(totalPages);
}

function renderClientsPagination(totalPages) {
  var paginationEl = document.getElementById('clientsPagination');
  if (!paginationEl) return;

  if (totalPages <= 1) {
    paginationEl.innerHTML = '';
    return;
  }

  var total = filteredClients.length;
  var start = (currentClientsPage - 1) * clientsPerPage + 1;
  var end = Math.min(currentClientsPage * clientsPerPage, total);

  var html = '<div class="pagination-info">Showing ' + start + '-' + end + ' of ' + total + ' clients</div>';
  html += '<div class="pagination-controls">';
  html += '<button class="pagination-btn prev" onclick="prevClientsPage()" ' + (currentClientsPage <= 1 ? 'disabled' : '') + '>' +
    '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button>';

  html += '<div class="pagination-pages">';
  var startPage = Math.max(1, currentClientsPage - 2);
  var endPage = Math.min(totalPages, startPage + 4);
  for (var p = startPage; p <= endPage; p++) {
    html += '<button class="pagination-page' + (p === currentClientsPage ? ' active' : '') + '" onclick="goToClientsPage(' + p + ')">' + p + '</button>';
  }
  html += '</div>';

  html += '<button class="pagination-btn next" onclick="nextClientsPage()" ' + (currentClientsPage >= totalPages ? 'disabled' : '') + '>' +
    '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></button>';
  html += '</div>';

  paginationEl.innerHTML = html;
}

function goToClientsPage(page) {
  currentClientsPage = page;
  renderClientsTable();
}

function prevClientsPage() {
  if (currentClientsPage > 1) {
    currentClientsPage--;
    renderClientsTable();
  }
}

function nextClientsPage() {
  var totalPages = Math.ceil(filteredClients.length / clientsPerPage);
  if (currentClientsPage < totalPages) {
    currentClientsPage++;
    renderClientsTable();
  }
}

function viewClient(rowIndex) {
  openLead(rowIndex);
}

function rebookClient(email, name) {
  // Open Add Lead modal with pre-filled client info
  openAddLead();

  // Pre-fill the form
  setTimeout(function() {
    document.getElementById('fieldContactPerson').value = name || '';
    document.getElementById('fieldEmail').value = email || '';

    // Fetch full client details and fill more fields
    google.script.run
      .withSuccessHandler(function(client) {
        if (client) {
          document.getElementById('fieldPhoneNumber').value = client.Phone_Number || '';
          document.getElementById('fieldCompanyName').value = client.Company_Name || '';
          document.getElementById('fieldTimeZone').value = client.Time_Zone || '';
          // Don't copy event-specific fields like date, event name, quote
        }
      })
      .getClientByEmail(email);
  }, 100);

  showToast('Creating new booking for ' + name, 'info');
}

function quickEmailClient(email, name) {
  if (!email) {
    showToast('No email address', 'error');
    return;
  }
  var subject = encodeURIComponent('Following Up - Dewayne Hill Entertainment');
  window.open('https://mail.google.com/mail/?view=cm&fs=1&to=' + email + '&su=' + subject, '_blank');
  showToast('Opened email for ' + name, 'success');
}
// ========== END CLIENTS VIEW FUNCTIONS ==========

function toggleSelect(rowIndex,checked){if(checked)selectedRecords.add(rowIndex);else selectedRecords.delete(rowIndex);updateBulkBar();}

function toggleSelectAll(){var all=document.getElementById('selectAll').checked;selectedRecords.clear();if(all)filteredRecords.forEach(function(r){selectedRecords.add(r.rowIndex);});renderTable();updateBulkBar();}

function updateBulkBar(){var bar=document.getElementById('bulkBar');document.getElementById('selectedCount').textContent=selectedRecords.size;bar.classList.toggle('visible',selectedRecords.size>0);}

function bulkEmail(){var sel=filteredRecords.filter(function(r){return selectedRecords.has(r.rowIndex);});if(!sel.length){showToast('No leads selected','error');return;}var bcc=sel.map(function(r){return r.Email;}).filter(function(e){return e;}).join(',');if(!bcc){showToast('No valid emails','error');return;}var subject=encodeURIComponent('Following Up - Dewayne Hill Entertainment');window.open('https://mail.google.com/mail/?view=cm&fs=1&bcc='+bcc+'&su='+subject,'_blank');showToast('Opened email for '+sel.length+' leads','success');}

function bulkGenerateContracts(){var sel=filteredRecords.filter(function(r){return selectedRecords.has(r.rowIndex);});if(!sel.length){showToast('No leads selected','error');return;}showLoading('Generating contracts...', true);updateProgress(0, sel.length);var done=0,errs=0;sel.forEach(function(rec){google.script.run.withSuccessHandler(function(res){done++;if(!res.success)errs++;updateProgress(done, sel.length);if(done===sel.length){hideLoading();if(errs)showToast('Completed with '+errs+' errors','warning');else showToast('Generated '+sel.length+' contracts!','success');}}).withFailureHandler(function(){done++;errs++;updateProgress(done, sel.length);if(done===sel.length){hideLoading();showToast('Completed with '+errs+' errors','warning');}}).generateContract(rec.rowIndex,currentUser?currentUser.name:'');});}

function openAddLead(){document.getElementById('modalTitle').textContent='Add Lead';document.getElementById('displayRecordId').textContent='';document.getElementById('leadForm').reset();document.getElementById('leadRowIndex').value='';document.getElementById('fieldLeadOwner').value=currentUser?currentUser.name:'';switchModalTab('details');openModal('leadModal');}

function openLead(rowIndex){showLoading('Loading lead...');google.script.run.withSuccessHandler(function(r){hideLoading();if(!r){showToast('Lead not found','error');return;}populateLeadForm(r);document.getElementById('modalTitle').textContent='Edit Lead';document.getElementById('displayRecordId').textContent=r.Record_ID||'';switchModalTab('details');openModal('leadModal');loadLeadActivities(r.Record_ID);}).withFailureHandler(function(e){hideLoading();console.error(e);showToast('Error loading lead','error');}).getLeadByRow(rowIndex);}

function populateLeadForm(r){
  document.getElementById('leadRowIndex').value=r.rowIndex||'';
  document.getElementById('fieldRecordId').value=r.Record_ID||'';
  document.getElementById('fieldContactPerson').value=r.Contact_Person||'';
  document.getElementById('fieldEmail').value=r.Email||'';
  document.getElementById('fieldPhoneNumber').value=r.Phone_Number||'';
  document.getElementById('fieldTimeZone').value=r.Time_Zone||'';
  document.getElementById('fieldTypeOfPhone').value=r.Type_of_Phone||'';
  document.getElementById('fieldLeadOwner').value=r.Lead_Owner||'';
  document.getElementById('fieldEventName').value=r.Event_Name||'';
  document.getElementById('fieldCategory').value=r.Category||'';

  // Set date first
  var dateValue = formatDateForInput(r.Date_of_Event);
  document.getElementById('fieldDateOfEvent').value=dateValue;

  // Set month - if it has a value, set it directly
  if(r.Month_of_Event){
    document.getElementById('fieldMonthOfEvent').value=r.Month_of_Event;
  }

  // Auto-calculate month if empty but date exists (run after slight delay for dropdowns to load)
  if(dateValue && !r.Month_of_Event){
    setTimeout(function(){
      console.log('[MonthAutoFill] Delayed auto-fill for existing lead');
      handleEventDateChange(dateValue);
    }, 100);
  }

  document.getElementById('fieldNumberOfGuests').value=r.Number_of_Guests||'';
  document.getElementById('fieldWhatPitched').value=r.What_Pitched||'';
  document.getElementById('fieldActiveQuote').value=r.Active_Quote||'';
  document.getElementById('fieldOldQuote').value=r.Old_Quote||'';
  document.getElementById('fieldCompanyName').value=r.Company_Name||'';
  document.getElementById('fieldCompanyAddress1').value=r.Company_Address1||'';
  document.getElementById('fieldCompanyAddress2').value=r.Company_Address2||'';
  document.getElementById('fieldCompanyCity').value=r.Company_City||'';
  document.getElementById('fieldCompanyState').value=r.Company_State||'';
  document.getElementById('fieldCompanyZip').value=r.Company_Zip||'';
  document.getElementById('fieldVenueName').value=r.Venue_Name||'';
  document.getElementById('fieldVenueAddress1').value=r.Venue_Address1||'';
  document.getElementById('fieldVenueAddress2').value=r.Venue_Address2||'';
  document.getElementById('fieldVenueCity').value=r.Venue_City||'';
  document.getElementById('fieldVenueState').value=r.Venue_State||'';
  document.getElementById('fieldVenueZip').value=r.Venue_Zip||'';
  document.getElementById('fieldLeadStatus').value=r.Lead_Status||'';
  document.getElementById('fieldLeadSource').value=r.Lead_Source||'';
  document.getElementById('fieldDateNextFollowup').value=formatDateForInput(r.Date_Next_Followup);
  document.getElementById('fieldMonthPitchEvent').value=r.Month_Pitch_Event||'';
  document.getElementById('fieldDhillCallList').value=r.Dhill_Call_List||'';
  document.getElementById('fieldDCallList').value=r.D_Call_List||'';
  document.getElementById('fieldCreateMockContract').value=r.Create_Mock_Contract||'';
  document.getElementById('fieldQuickCallNotes').value=r.Quick_Call_Notes||'';
  document.getElementById('fieldAddToBooklist').value=r.Add_to_Booklist||'';
  document.getElementById('fieldAddToPCL').value=r.Add_to_PCL||'';
  document.getElementById('fieldAdditionalNotes').value=r.Additional_Notes||'';
  document.getElementById('fieldFollowupNotes').value=r.Followup_Notes||'';
  document.getElementById('fieldDateLastTouch').value=r.Date_Last_Touch||'';
  document.getElementById('fieldCreatedDate').value=r.Created_Date||'';
  document.getElementById('fieldCreatedBy').value=r.Created_By||'';
  document.getElementById('fieldLastModifiedBy').value=r.Last_Modified_By||'';
  document.getElementById('fieldPriorityScore').value=r.Priority_Score||'';
  document.getElementById('fieldContractId').value=r.Contract_ID||'';
}

function saveLead(){
  var rowIndex=document.getElementById('leadRowIndex').value;
  var data={
    Contact_Person:document.getElementById('fieldContactPerson').value,
    Email:document.getElementById('fieldEmail').value,
    Phone_Number:document.getElementById('fieldPhoneNumber').value,
    Time_Zone:document.getElementById('fieldTimeZone').value,
    Type_of_Phone:document.getElementById('fieldTypeOfPhone').value,
    Lead_Owner:document.getElementById('fieldLeadOwner').value,
    Event_Name:document.getElementById('fieldEventName').value,
    Category:document.getElementById('fieldCategory').value,
    Date_of_Event:document.getElementById('fieldDateOfEvent').value,
    Month_of_Event:document.getElementById('fieldMonthOfEvent').value,
    Number_of_Guests:document.getElementById('fieldNumberOfGuests').value,
    What_Pitched:document.getElementById('fieldWhatPitched').value,
    Active_Quote:document.getElementById('fieldActiveQuote').value,
    Old_Quote:document.getElementById('fieldOldQuote').value,
    Company_Name:document.getElementById('fieldCompanyName').value,
    Company_Address1:document.getElementById('fieldCompanyAddress1').value,
    Company_Address2:document.getElementById('fieldCompanyAddress2').value,
    Company_City:document.getElementById('fieldCompanyCity').value,
    Company_State:document.getElementById('fieldCompanyState').value,
    Company_Zip:document.getElementById('fieldCompanyZip').value,
    Venue_Name:document.getElementById('fieldVenueName').value,
    Venue_Address1:document.getElementById('fieldVenueAddress1').value,
    Venue_Address2:document.getElementById('fieldVenueAddress2').value,
    Venue_City:document.getElementById('fieldVenueCity').value,
    Venue_State:document.getElementById('fieldVenueState').value,
    Venue_Zip:document.getElementById('fieldVenueZip').value,
    Lead_Status:document.getElementById('fieldLeadStatus').value,
    Lead_Source:document.getElementById('fieldLeadSource').value,
    Date_Next_Followup:document.getElementById('fieldDateNextFollowup').value,
    Month_Pitch_Event:document.getElementById('fieldMonthPitchEvent').value,
    Dhill_Call_List:document.getElementById('fieldDhillCallList').value,
    D_Call_List:document.getElementById('fieldDCallList').value,
    Create_Mock_Contract:document.getElementById('fieldCreateMockContract').value,
    Quick_Call_Notes:document.getElementById('fieldQuickCallNotes').value,
    Add_to_Booklist:document.getElementById('fieldAddToBooklist').value,
    Add_to_PCL:document.getElementById('fieldAddToPCL').value,
    Additional_Notes:document.getElementById('fieldAdditionalNotes').value,
    Followup_Notes:document.getElementById('fieldFollowupNotes').value
  };

  if(!data.Contact_Person){showToast('Contact Person required','error');return;}

  // VL1 & VL2: Client-side validation
  var validation=validateLeadClientSide(data);
  if(!validation.isValid){
    showValidationErrors(validation.errors);
    return;
  }
  hideValidationErrors();

  showLoading('Saving changes...');

  if(rowIndex){
    // Update existing lead
    google.script.run.withSuccessHandler(function(res){
      hideLoading();
      if(res.success){
        showToast('Lead updated!','success');
        closeModal('leadModal');
        if(currentView==='dashboard')loadDashboard();else loadListView(currentView);
        refreshSidebarCounts();
      }else showToast('Error: '+(res.error||'Unknown'),'error');
    }).withFailureHandler(function(e){hideLoading();handleError(e);}).updateLead(parseInt(rowIndex),data,currentUser?currentUser.name:'');
  }else{
    // Create new lead
    google.script.run.withSuccessHandler(function(res){
      hideLoading();
      if(res.success){
        showToast('Lead created!','success');
        closeModal('leadModal');
        if(currentView==='dashboard')loadDashboard();else loadListView(currentView);
        refreshSidebarCounts();
      }else showToast('Error: '+(res.error||'Unknown'),'error');
    }).withFailureHandler(function(e){hideLoading();handleError(e);}).createLead(data,currentUser?currentUser.name:'');
  }
}

// VL1 & VL2: Client-side validation
function validateLeadClientSide(data){
  var errors=[];

  // VL1: Hot/Super Hot/Contract Lead requires phone, event date, followup date
  if(['Hot','Super Hot','Contract Lead'].indexOf(data.Lead_Status)>=0){
    if(!data.Phone_Number||data.Phone_Number.trim()===''){
      errors.push('Phone number is required for '+data.Lead_Status+' status');
    }
    if(!data.Date_of_Event){
      errors.push('Event date is required for '+data.Lead_Status+' status');
    }
    if(!data.Date_Next_Followup){
      errors.push('Follow-up date is required for '+data.Lead_Status+' status');
    }
  }

  // VL2: Booked requires quote, city, state, contact, email
  if(data.Lead_Status==='Booked'){
    var quoteVal=parseFloat(String(data.Active_Quote||'0').replace(/[^0-9.-]/g,''))||0;
    if(quoteVal<=0){
      errors.push('Quote amount is required for Booked status');
    }
    if(!data.Company_City&&!data.Venue_City){
      errors.push('City is required for Booked status');
    }
    if(!data.Company_State&&!data.Venue_State){
      errors.push('State is required for Booked status');
    }
    if(!data.Contact_Person||data.Contact_Person.trim()===''){
      errors.push('Contact person is required for Booked status');
    }
    if(!data.Email||data.Email.trim()===''){
      errors.push('Email is required for Booked status');
    }
  }

  return{isValid:errors.length===0,errors:errors};
}

function showValidationErrors(errors){
  var container=document.getElementById('validationErrors');
  var list=document.getElementById('validationErrorsList');
  if(container&&list){
    list.innerHTML=errors.map(function(e){return'<li>'+escapeHtml(e)+'</li>';}).join('');
    container.classList.add('active');
  }
}

function hideValidationErrors(){
  var container=document.getElementById('validationErrors');
  if(container)container.classList.remove('active');
}

// N2: Duplicate detection on create/edit
function checkDuplicatesBeforeSave(email,phone,callback){
  if(!email&&!phone){callback(false);return;}

  // Get current Record_ID to exclude from duplicate check (for existing leads)
  var currentRecordId = document.getElementById('fieldRecordId').value || '';

  google.script.run.withSuccessHandler(function(result){
    if(result.hasDuplicate){
      showDuplicateWarning(result.duplicates);
      callback(true,result.duplicates);
    }else{
      hideDuplicateWarning();
      callback(false);
    }
  }).withFailureHandler(function(){callback(false);}).checkForDuplicates(email,phone,currentRecordId);
}

function showDuplicateWarning(duplicates){
  var container=document.getElementById('duplicateWarning');
  var list=document.getElementById('duplicateList');
  if(container&&list){
    list.innerHTML=duplicates.map(function(d){
      return'<div class="duplicate-item"><div class="duplicate-item-info"><div class="duplicate-item-name">'+escapeHtml(d.contactPerson||'Unknown')+'</div><div class="duplicate-item-meta">'+escapeHtml(d.email||'-')+' | '+escapeHtml(d.phone||'-')+' | '+escapeHtml(d.status||'-')+' | '+escapeHtml(d.location||'-')+'</div></div><div class="duplicate-item-match">Match: '+escapeHtml(d.matchType)+'</div></div>';
    }).join('');
    container.classList.add('active');
  }
}

function hideDuplicateWarning(){
  var container=document.getElementById('duplicateWarning');
  if(container)container.classList.remove('active');
}

function openCallMode(idx){
  callQueueIndex=idx;
  var r=callQueue[idx];
  if(!r){showToast('No lead found','error');return;}
  currentCallRecord=r;
  document.getElementById('callAvatar').textContent=getInitials(r.Contact_Person||'U');
  document.getElementById('callName').textContent=r.Contact_Person||'Unknown';
  document.getElementById('callEvent').textContent=r.Event_Name||'No event';

  var phoneEl = document.getElementById('callPhone');
  phoneEl.textContent=r.Phone_Number||'-';
  phoneEl.href='tel:'+(r.Phone_Number||'');
  // Add Dialpad click handler
  phoneEl.onclick = function(e){
    e.preventDefault();
    if(r.Phone_Number) dialpadCallFromModal(r.Phone_Number);
  };

  document.getElementById('callQuote').textContent=formatCurrency(r.Active_Quote);
  document.getElementById('callEventDate').textContent=formatDate(r.Date_of_Event)||'-';
  document.getElementById('callNotes').textContent=r.Additional_Notes||r.Quick_Call_Notes||'-';
  document.getElementById('callQuickNote').value='';
  document.getElementById('callStatusUpdate').style.display='none';
  document.querySelectorAll('.result-btn,.status-btn').forEach(function(b){b.classList.remove('active');});
  openModal('callModal');
}

// Variable to store pending call for call method modal
var pendingCallData = null;

// Dialpad call from Call Mode modal - supports mixed usage based on user's Call_Method setting
function dialpadCallFromModal(phone){
  console.log('dialpadCallFromModal called with:', phone);
  console.log('currentUser:', currentUser);

  if(!phone){showToast('No phone number','error');return;}

  var userName = currentUser ? currentUser.name : '';
  var callMethod = currentUser ? currentUser.callMethod : 'dialpad';

  console.log('userName:', userName, 'callMethod:', callMethod);

  if(!userName){
    showToast('Please log in to make calls','error');
    return;
  }

  var cleanPhone = phone.replace(/[^0-9+]/g, '');
  var leadRecordId = currentCallRecord ? currentCallRecord.Record_ID : null;

  // Check user's call method preference
  if(callMethod === 'both'){
    console.log('callMethod is "both", showing choice modal');
    // Show choice modal for users with both options
    showCallMethodModal(cleanPhone, leadRecordId, 'modal');
    return;
  }

  if(callMethod === 'phone'){
    console.log('Using phone call');
    // Use phone link (for cell phone users)
    executePhoneCall(cleanPhone, leadRecordId, userName, 'modal');
  } else {
    console.log('Using dialpad call');
    // Use Dialpad (default for team members)
    executeDialpadCall(cleanPhone, leadRecordId, userName, 'modal');
  }
}

// Execute phone call via tel: link
function executePhoneCall(phone, leadRecordId, userName, source){
  console.log('=== executePhoneCall CALLED ===');
  console.log('Phone:', phone);
  console.log('Lead Record ID:', leadRecordId);
  console.log('User Name:', userName);
  console.log('Source:', source);

  if(!phone){
    console.error('ERROR: No phone number provided');
    showToast('No phone number to call','error');
    return;
  }

  showToast('Opening phone dialer...','info');

  // Format phone for tel: link (remove all non-numeric except +)
  var formattedPhone = String(phone).replace(/[^0-9+]/g, '');
  console.log('Formatted phone for tel:', formattedPhone);

  // Create tel URL
  var telUrl = 'tel:' + formattedPhone;
  console.log('Tel URL:', telUrl);

  // Open phone dialer
  window.location.href = telUrl;
  console.log('Tel link executed');

  // Log metrics and activity
  if(userName){
    google.script.run.incrementMetric(userName,'Calls_Made',1);
  }
  if(leadRecordId){
    google.script.run.logCallActivity(leadRecordId, phone, userName, 'Initiated');
  }

  showToast('Phone dialer opened!','success');
}

// Execute call via Dialpad
function executeDialpadCall(phone, leadRecordId, userName, source){
  console.log('=== executeDialpadCall CALLED ===');
  console.log('Phone:', phone);
  console.log('Lead Record ID:', leadRecordId);
  console.log('User Name:', userName);
  console.log('Source:', source);
  console.log('Current User object:', currentUser);

  if(!phone){
    console.error('ERROR: No phone number provided');
    showToast('No phone number to call','error');
    return;
  }

  // Check if user has Dialpad configured
  var dialpadEmail = currentUser ? currentUser.dialpadEmail : '';
  console.log('Dialpad Email:', dialpadEmail);

  if(!dialpadEmail){
    console.error('ERROR: No Dialpad email configured');
    showToast('Dialpad not configured for your account. Contact admin.','error');
    return;
  }

  showToast('Connecting via Dialpad...','info');
  console.log('Calling backend initiateCallForUser with:', phone, userName);

  google.script.run
    .withSuccessHandler(function(res){
      console.log('=== Dialpad SUCCESS Handler ===');
      console.log('Full response:', JSON.stringify(res));
      if(res.success){
        showToast('Dialpad is calling your phone...','success');
        google.script.run.incrementMetric(userName,'Calls_Made',1);
        // Log call activity to lead timeline
        if(leadRecordId){
          google.script.run.logCallActivity(leadRecordId, phone, userName, 'Initiated');
        }
      } else {
        console.warn('Dialpad error details:', res.error, res);
        showToast(formatDialpadError(res.error),'error');
      }
    })
    .withFailureHandler(function(e){
      console.error('=== Dialpad FAILURE Handler ===');
      console.error('Error:', e);
      console.error('Error message:', e.message || e.toString());
      showToast('Dialpad connection failed. Make sure Dialpad is running.','error');
    })
    .initiateCallForUser(phone, userName);
}

// Format phone number for display
function formatPhoneNumber(phone){
  if(!phone) return '---';
  var cleaned = String(phone).replace(/\D/g, '');
  if(cleaned.length === 10){
    return '(' + cleaned.slice(0,3) + ') ' + cleaned.slice(3,6) + '-' + cleaned.slice(6);
  } else if(cleaned.length === 11 && cleaned[0] === '1'){
    return '+1 (' + cleaned.slice(1,4) + ') ' + cleaned.slice(4,7) + '-' + cleaned.slice(7);
  }
  return phone;
}

// Show call method choice modal for users with "both" setting
function showCallMethodModal(phone, leadRecordId, source){
  console.log('showCallMethodModal called:', phone, leadRecordId, source);
  pendingCallData = { phone: phone, leadRecordId: leadRecordId, source: source };
  var modal = document.getElementById('callMethodModal');
  console.log('callMethodModal element:', modal);
  if(modal){
    var phoneDisplay = document.getElementById('callMethodPhone');
    if(phoneDisplay) phoneDisplay.textContent = formatPhoneNumber(phone);
    modal.classList.add('active');
    console.log('Modal activated');
  } else {
    console.warn('callMethodModal not found, falling back to phone');
    // Fallback to phone if modal not found
    executePhoneCall(phone, leadRecordId, currentUser.name, source);
  }
}

// Close call method modal
function closeCallMethodModal(){
  console.log('=== closeCallMethodModal CALLED ===');
  var modal = document.getElementById('callMethodModal');
  if(modal){
    modal.classList.remove('active');
    console.log('Modal closed');
  } else {
    console.warn('Modal element not found');
  }
  pendingCallData = null;
}

// Handle call method selection from modal
function selectCallMethod(method){
  console.log('=== selectCallMethod CALLED ===');
  console.log('Method selected:', method);
  console.log('Pending call data:', pendingCallData);

  if(!pendingCallData){
    console.error('ERROR: No pending call data - pendingCallData is null!');
    showToast('Error: Call data not found. Please try again.','error');
    closeCallMethodModal();
    return;
  }

  // Extract ALL data from pendingCallData BEFORE closing modal
  // (closeCallMethodModal sets pendingCallData = null)
  var phone = pendingCallData.phone;
  var leadRecordId = pendingCallData.leadRecordId;
  var source = pendingCallData.source;
  var userName = currentUser ? currentUser.name : '';

  console.log('Extracted call data:');
  console.log('  Phone:', phone);
  console.log('  Lead Record ID:', leadRecordId);
  console.log('  Source:', source);
  console.log('  User Name:', userName);

  // Now close modal (this sets pendingCallData = null)
  closeCallMethodModal();

  // Execute call with extracted data
  if(method === 'phone'){
    console.log('Executing phone call...');
    executePhoneCall(phone, leadRecordId, userName, source);
  } else {
    console.log('Executing Dialpad call...');
    executeDialpadCall(phone, leadRecordId, userName, source);
  }
}

// Format Dialpad error for user-friendly display
function formatDialpadError(error){
  if(!error) return 'Dialpad call failed';
  var msg = String(error).toLowerCase();
  if(msg.includes('not found') || msg.includes('user')) return 'Dialpad call failed: User not configured';
  if(msg.includes('permission') || msg.includes('unauthorized') || msg.includes('403')) return 'Dialpad call failed: Permission denied';
  if(msg.includes('invalid') && msg.includes('phone')) return 'Dialpad call failed: Invalid phone number';
  if(msg.includes('rate') || msg.includes('limit')) return 'Dialpad call failed: Too many requests';
  return 'Dialpad call failed: ' + (error.length > 50 ? error.substring(0,50) + '...' : error);
}

function selectCallResult(btn){document.querySelectorAll('.result-btn').forEach(function(b){b.classList.remove('active');});btn.classList.add('active');document.getElementById('callStatusUpdate').style.display=btn.dataset.result==='Talked'?'block':'none';}

function selectStatus(btn){document.querySelectorAll('.status-btn').forEach(function(b){b.classList.remove('active');});btn.classList.add('active');}

function saveCallAndNext(){if(!currentCallRecord)return;var resultBtn=document.querySelector('.result-btn.active');var statusBtn=document.querySelector('.status-btn.active');var note=document.getElementById('callQuickNote').value;var data={Quick_Call_Notes:resultBtn?resultBtn.dataset.result:'',Additional_Notes:note?((currentCallRecord.Additional_Notes||'')+'\n['+new Date().toLocaleDateString()+'] '+note):currentCallRecord.Additional_Notes};if(statusBtn)data.Lead_Status=statusBtn.dataset.status;showLoading('Saving...');google.script.run.withSuccessHandler(function(res){hideLoading();if(res.success){showToast('Call logged!','success');closeModal('callModal');google.script.run.incrementMetric(currentUser?currentUser.name:'','Calls_Made',1);callQueueIndex++;if(callQueueIndex<callQueue.length)setTimeout(function(){openCallMode(callQueueIndex);},300);else{showToast('Queue complete!','success');loadDashboard();}}else showToast('Error saving','error');}).withFailureHandler(function(e){hideLoading();handleError(e);}).updateLead(currentCallRecord.rowIndex,data,currentUser?currentUser.name:'');}

function quickCall(rowIndex){
  var r=filteredRecords.find(function(x){return x.rowIndex===rowIndex;});
  if(!r||!r.Phone_Number){showToast('No phone number','error');return;}

  var phone = r.Phone_Number;
  var userName = currentUser ? currentUser.name : '';
  var callMethod = currentUser ? currentUser.callMethod : 'dialpad';
  var leadRecordId = r.Record_ID;

  if(!userName){
    showToast('Please log in to make calls','error');
    return;
  }

  var cleanPhone = phone.replace(/[^0-9+]/g, '');

  // Check user's call method preference
  if(callMethod === 'both'){
    showCallMethodModal(cleanPhone, leadRecordId, 'quick');
    return;
  }

  if(callMethod === 'phone'){
    executePhoneCall(cleanPhone, leadRecordId, userName, 'quick');
  } else {
    executeDialpadCall(cleanPhone, leadRecordId, userName, 'quick');
  }
}

function quickEmail(rowIndex){var r=filteredRecords.find(function(x){return x.rowIndex===rowIndex;});if(r&&r.Email){var subject=encodeURIComponent('Following Up - '+(r.Event_Name||'Your Event'));window.open('https://mail.google.com/mail/?view=cm&fs=1&to='+encodeURIComponent(r.Email)+'&su='+subject,'_blank');google.script.run.incrementMetric(currentUser?currentUser.name:'','Followups_Sent',1);}else showToast('No email','error');}

function callLead(){
  var phone=document.getElementById('fieldPhoneNumber').value;
  if(!phone){showToast('No phone number','error');return;}

  var userName = currentUser ? currentUser.name : '';
  var callMethod = currentUser ? currentUser.callMethod : 'dialpad';
  if(!userName){
    showToast('Please log in to make calls','error');
    return;
  }

  // Get the current lead's Record_ID for activity logging
  var leadRecordId = document.getElementById('fieldRecordId').value;
  var cleanPhone = phone.replace(/[^0-9+]/g, '');

  // Check user's call method preference
  if(callMethod === 'both'){
    showCallMethodModal(cleanPhone, leadRecordId, 'lead');
    return;
  }

  if(callMethod === 'phone'){
    executePhoneCall(cleanPhone, leadRecordId, userName, 'lead');
  } else {
    executeDialpadCall(cleanPhone, leadRecordId, userName, 'lead');
  }
}

function emailLead(){var email=document.getElementById('fieldEmail').value;var evt=document.getElementById('fieldEventName').value;if(email){var subject=encodeURIComponent('Following Up - '+(evt||'Your Event'));window.open('https://mail.google.com/mail/?view=cm&fs=1&to='+encodeURIComponent(email)+'&su='+subject,'_blank');google.script.run.incrementMetric(currentUser?currentUser.name:'','Followups_Sent',1);}else showToast('No email','error');}

function generateContract(){
  var rowIndex = document.getElementById('leadRowIndex').value;
  console.log('=== generateContract CALLED (Frontend) ===');
  console.log('Row Index from form:', rowIndex);
  console.log('Current User:', currentUser ? currentUser.name : 'NOT SET');

  if(!rowIndex){
    console.error('ERROR: No rowIndex - lead must be saved first');
    showToast('Save lead first','error');
    return;
  }

  var parsedRowIndex = parseInt(rowIndex);
  var userName = currentUser ? currentUser.name : '';

  console.log('Calling backend generateContract with:', {
    rowIndex: parsedRowIndex,
    userName: userName
  });

  showLoading('Generating contract...');

  google.script.run
    .withSuccessHandler(function(res){
      hideLoading();
      console.log('=== generateContract SUCCESS HANDLER ===');
      console.log('Full response:', JSON.stringify(res, null, 2));

      if(res.success){
        console.log('Contract generated successfully!');
        console.log('Contract ID:', res.contractId);
        console.log('Contract URL:', res.url);
        console.log('Status updated:', res.statusUpdated, 'to', res.newStatus);

        // Show success message with status update info
        var msg = 'Contract generated!';
        if(res.statusUpdated) {
          msg += ' Status updated to ' + res.newStatus + '.';
        }
        showToast(msg, 'success');

        // Refresh sidebar counts
        refreshSidebarCounts();

        // Refresh the lead modal if open to show updated status
        var currentRowIndex = document.getElementById('leadRowIndex').value;
        if(currentRowIndex && typeof loadLeadDetails === 'function') {
          console.log('Refreshing lead details for row:', currentRowIndex);
          loadLeadDetails(parseInt(currentRowIndex));
        }

        // Refresh the leads table to show updated status
        if(typeof loadLeads === 'function') {
          console.log('Refreshing leads table...');
          loadLeads(currentView || 'all');
        }

        // Refresh contracts folder
        if(typeof loadContractsFolder === 'function') {
          loadContractsFolder();
        }

        // Open the contract URL
        if(res.url){
          console.log('Opening contract URL in new tab...');
          window.open(res.url,'_blank');
        }
      } else {
        console.error('Contract generation failed!');
        console.error('Error:', res.error);
        if(res.stack) console.error('Stack:', res.stack);
        showToast('Error: '+(res.error||'Unknown error - check Apps Script logs'),'error');
      }
    })
    .withFailureHandler(function(e){
      hideLoading();
      console.error('=== generateContract FAILURE HANDLER ===');
      console.error('Error object:', e);
      console.error('Error message:', e.message || e.toString());
      showToast('Contract generation failed: ' + (e.message || e.toString()), 'error');
      handleError(e);
    })
    .generateContract(parsedRowIndex, userName);
}

function loadResearchQueue(){showLoading('Loading research...');google.script.run.withSuccessHandler(function(items){hideLoading();researchQueue=items||[];renderResearchList();var count=researchQueue.length;var navBadge=document.getElementById('navResearchCount');if(navBadge){navBadge.textContent=count+' pending';}var sidebarBadge=document.querySelector('.nav-item[data-view="research"] .nav-badge');if(sidebarBadge){sidebarBadge.textContent=count;}}).withFailureHandler(function(e){hideLoading();console.error(e);researchQueue=[];renderResearchList();}).getResearchQueue();}

function renderResearchList(){var c=document.getElementById('researchList');if(!researchQueue.length){c.innerHTML='<div class="empty-state"><p>No pending research</p></div>';return;}c.innerHTML=researchQueue.map(function(item,i){var act=(currentResearchItem&&currentResearchItem.rowIndex===item.rowIndex)?'active':'';return'<div class="research-item '+act+'" onclick="selectResearchItem('+i+')"><div class="research-item-city">'+escapeHtml(item.City_Location||'Unknown')+'</div><div class="research-item-type">'+escapeHtml(item.Event_Type||item.Looking_For||'Unknown')+'</div><div class="research-item-meta"><span>'+escapeHtml(item.Date_Needed||'-')+'</span><span class="status status-'+(item.Research_Status==='Pending'?'cold':'warm')+'">'+escapeHtml(item.Research_Status||'Pending')+'</span></div></div>';}).join('');}

function selectResearchItem(idx){currentResearchItem=researchQueue[idx];currentResearchData={City:currentResearchItem.City_Location||'',Event_Type:currentResearchItem.Event_Type||'',Looking_For:currentResearchItem.Looking_For||'',Message:currentResearchItem.Message||''};resetResearchTimer();document.getElementById('researchEmptyState').style.display='none';document.getElementById('researchDetail').style.display='block';document.getElementById('researchRowIndex').value=currentResearchItem.rowIndex;document.getElementById('researchBarkName').textContent=currentResearchItem.Bark_Name||'-';document.getElementById('researchBarkEmailPartial').textContent=currentResearchItem.Bark_Email_Partial||'-';document.getElementById('researchBarkPhonePartial').textContent=currentResearchItem.Bark_Phone_Partial||'-';document.getElementById('researchLookingFor').textContent=currentResearchItem.Looking_For||'-';document.getElementById('researchCity').textContent=currentResearchItem.City_Location||'-';document.getElementById('researchEventType').textContent=currentResearchItem.Event_Type||'-';document.getElementById('researchDateNeeded').textContent=currentResearchItem.Date_Needed||'-';document.getElementById('researchGuestCount').textContent=currentResearchItem.Guest_Count||'-';document.getElementById('researchBudget').textContent=currentResearchItem.Budget_Range||'-';document.getElementById('researchMessage').textContent=currentResearchItem.Message||'-';document.getElementById('researchFoundName').value=currentResearchItem.Found_Name||'';document.getElementById('researchFoundCompany').value=currentResearchItem.Found_Company||'';document.getElementById('researchFoundEmail').value=currentResearchItem.Found_Email||'';document.getElementById('researchFoundPhone').value=currentResearchItem.Found_Phone||'';var liInput=document.getElementById('linkedinUrlInput');if(liInput)liInput.value='';renderResearchList();}

function openAddResearch(){
  // Clear form - including new Bark fields
  document.getElementById('researchFormBarkName').value = '';
  document.getElementById('researchFormBarkEmail').value = '';
  document.getElementById('researchFormBarkPhone').value = '';
  document.getElementById('researchFormCity').value = '';
  document.getElementById('researchFormEventType').value = '';
  document.getElementById('researchFormDateNeeded').value = '';
  document.getElementById('researchFormGuestCount').value = '';
  document.getElementById('researchFormBudget').value = '';
  document.getElementById('researchFormMessage').value = '';
  // Open modal
  document.getElementById('addResearchModal').classList.add('active');
}

function submitAddResearch(){
  var city = document.getElementById('researchFormCity').value.trim();
  if(!city){
    showToast('City/Location is required', 'error');
    return;
  }

  var researchData = {
    // Bark Info fields
    Bark_Name: document.getElementById('researchFormBarkName').value.trim(),
    Bark_Email_Partial: document.getElementById('researchFormBarkEmail').value.trim(),
    Bark_Phone_Partial: document.getElementById('researchFormBarkPhone').value.trim(),
    // Existing fields
    City_Location: city,
    Event_Type: document.getElementById('researchFormEventType').value.trim(),
    Date_Needed: document.getElementById('researchFormDateNeeded').value,
    Guest_Count: document.getElementById('researchFormGuestCount').value.trim(),
    Budget_Range: document.getElementById('researchFormBudget').value.trim(),
    Message: document.getElementById('researchFormMessage').value.trim(),
    Research_Status: 'Pending'
  };

  showLoading('Adding to research queue...');

  google.script.run
    .withSuccessHandler(function(res){
      hideLoading();
      if(res.success){
        showToast('Research item added!', 'success');
        closeModal('addResearchModal');
        loadResearchQueue();
      } else {
        showToast(res.error || 'Error adding research', 'error');
      }
    })
    .withFailureHandler(function(err){
      hideLoading();
      showToast('Error: ' + err.message, 'error');
    })
    .addResearchItem(researchData, currentUser ? currentUser.name : '');
}

// Contracts Folder Variables
var allContracts = [];
var filteredContracts = [];
var contractsPerPage = 15;
var currentContractsPage = 1;

// Load Contracts Folder View
function loadContractsFolder(){
  var tbody = document.getElementById('contractsFolderTableBody');
  var countEl = document.getElementById('contractsFolderCount');
  var navCountEl = document.getElementById('navContractsFolderCount');
  var searchInput = document.getElementById('contractsSearchInput');
  var loadingEl = document.getElementById('contractsLoading');

  // Show loading spinner
  if(loadingEl) loadingEl.classList.add('active');
  if(tbody) tbody.innerHTML = '';
  if(searchInput) searchInput.value = '';

  google.script.run
    .withSuccessHandler(function(result){
      // Hide loading spinner
      if(loadingEl) loadingEl.classList.remove('active');

      if(!result || !result.contracts || result.contracts.length === 0){
        allContracts = [];
        filteredContracts = [];
        if(tbody) tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:var(--text-muted);">No contracts generated yet</td></tr>';
        if(countEl) countEl.textContent = '0 contracts';
        if(navCountEl) navCountEl.textContent = '0';
        document.getElementById('contractsPagination').style.display = 'none';
        return;
      }

      allContracts = result.contracts;
      filteredContracts = allContracts.slice();
      if(countEl) countEl.textContent = allContracts.length + ' contracts';
      if(navCountEl) navCountEl.textContent = allContracts.length;
      currentContractsPage = 1;
      renderContractsTable();
    })
    .withFailureHandler(function(err){
      // Hide loading spinner
      if(loadingEl) loadingEl.classList.remove('active');

      allContracts = [];
      filteredContracts = [];
      if(tbody) tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:var(--text-muted);">Error loading contracts</td></tr>';
      document.getElementById('contractsPagination').style.display = 'none';
      console.error('Error loading contracts:', err);
    })
    .getContractsList();
}

function filterContracts(){
  var searchInput = document.getElementById('contractsSearchInput');
  var searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';

  if(!searchTerm){
    filteredContracts = allContracts.slice();
  } else {
    filteredContracts = allContracts.filter(function(c){
      return (c.contractName && c.contractName.toLowerCase().indexOf(searchTerm) >= 0) ||
             (c.eventName && c.eventName.toLowerCase().indexOf(searchTerm) >= 0) ||
             (c.createdBy && c.createdBy.toLowerCase().indexOf(searchTerm) >= 0);
    });
  }

  currentContractsPage = 1;
  renderContractsTable();
}

function renderContractsTable(){
  var tbody = document.getElementById('contractsFolderTableBody');
  var paginationEl = document.getElementById('contractsPagination');
  var countEl = document.getElementById('contractsFolderCount');
  var loadingEl = document.getElementById('contractsLoading');

  // Hide loading overlay
  if(loadingEl) loadingEl.classList.remove('active');

  if(!filteredContracts.length){
    if(tbody) tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:var(--text-muted);">No contracts found</td></tr>';
    if(paginationEl) paginationEl.style.display = 'none';
    if(countEl) countEl.textContent = '0 contracts';
    return;
  }

  var totalPages = Math.ceil(filteredContracts.length / contractsPerPage);
  var startIdx = (currentContractsPage - 1) * contractsPerPage;
  var endIdx = Math.min(startIdx + contractsPerPage, filteredContracts.length);
  var pageContracts = filteredContracts.slice(startIdx, endIdx);

  if(countEl) countEl.textContent = filteredContracts.length + ' contracts';

  if(tbody){
    tbody.innerHTML = pageContracts.map(function(c){
      var dateStr = c.dateGenerated ? formatDateDisplay(c.dateGenerated) : '-';
      var amount = c.amount ? '$' + parseFloat(c.amount).toLocaleString() : '-';

      // Event Name column: combine Event Name + Date of Event
      var eventDisplay = c.eventName || 'Contract';
      if(c.eventDate) {
        eventDisplay += '<br><span style="font-size:0.8125rem;color:var(--text-muted);">' + escapeHtml(c.eventDate) + '</span>';
      }

      var clientName = c.contactName || '-';
      var createdBy = c.createdBy || '-';

      // Actions: View and Send buttons - aligned properly
      var actionsHtml = '';
      if(c.pdfUrl){
        actionsHtml = '<div class="contract-actions">';
        actionsHtml += '<a href="' + escapeHtml(c.pdfUrl) + '" target="_blank" class="btn btn-sm btn-primary">View</a>';
        actionsHtml += '<button class="btn btn-sm btn-send" onclick="sendContract(\'' + escapeHtml(c.contractId || '') + '\', \'' + escapeHtml(c.leadRecordId || '') + '\', \'' + escapeHtml((c.eventName || '').replace(/'/g, "\\'")) + '\', \'' + escapeHtml((c.clientEmail || '').replace(/'/g, "\\'")) + '\')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;margin-right:4px;"><path d="M22 2L11 13"/><path d="M22 2L15 22L11 13L2 9L22 2Z"/></svg>Send</button>';
        actionsHtml += '</div>';
      } else {
        actionsHtml = '<span style="color:var(--text-muted);">No PDF</span>';
      }

      return '<tr>' +
        '<td style="font-weight:600;color:var(--text-primary);">' + eventDisplay + '</td>' +
        '<td>' + escapeHtml(clientName) + '</td>' +
        '<td>' + escapeHtml(createdBy) + '</td>' +
        '<td style="color:var(--text-secondary);font-weight:600;">' + amount + '</td>' +
        '<td>' + dateStr + '</td>' +
        '<td>' + actionsHtml + '</td>' +
      '</tr>';
    }).join('');
  }

  // Update pagination (use team-pagination style)
  if(totalPages > 1){
    if(paginationEl) paginationEl.style.display = 'flex';
    renderContractsPagination(totalPages);
  } else {
    if(paginationEl) paginationEl.style.display = 'none';
  }
}

function renderContractsPagination(totalPages){
  var paginationEl = document.getElementById('contractsPagination');
  if (!paginationEl) return;

  if (totalPages <= 1) {
    paginationEl.innerHTML = '';
    paginationEl.style.display = 'none';
    return;
  }

  // Use same style as team leaderboard pagination
  var html = '<button class="page-btn" onclick="changeContractsPage(-1)" ' + (currentContractsPage <= 1 ? 'disabled' : '') + '>' +
    '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15,18 9,12 15,6"/></svg>' +
  '</button>';

  for (var p = 1; p <= totalPages; p++) {
    html += '<button class="page-btn ' + (p === currentContractsPage ? 'active' : '') + '" onclick="goToContractsPage(' + p + ')">' + p + '</button>';
  }

  html += '<button class="page-btn" onclick="changeContractsPage(1)" ' + (currentContractsPage >= totalPages ? 'disabled' : '') + '>' +
    '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9,18 15,12 9,6"/></svg>' +
  '</button>';

  paginationEl.innerHTML = html;
  paginationEl.style.display = 'flex';
}

function changeContractsPage(delta){
  var totalPages = Math.ceil(filteredContracts.length / contractsPerPage);
  var newPage = currentContractsPage + delta;
  if(newPage >= 1 && newPage <= totalPages){
    currentContractsPage = newPage;
    renderContractsTable();
  }
}

function goToContractsPage(page){
  currentContractsPage = page;
  renderContractsTable();
}

// Variable to store pending send contract data
var pendingSendContract = null;

// Send contract email to lead - shows branded confirmation modal
function sendContract(contractId, leadRecordId, eventName, clientEmail){
  if(!contractId || !leadRecordId){
    showToast('Contract information missing','error');
    return;
  }

  // Store pending data
  pendingSendContract = { contractId: contractId, leadRecordId: leadRecordId };

  // Populate modal with details
  var detailsEl = document.getElementById('sendContractDetails');
  if(detailsEl){
    detailsEl.innerHTML =
      '<div class="send-detail-row"><span class="send-detail-label">Event</span><span class="send-detail-value">' + escapeHtml(eventName || 'Contract') + '</span></div>' +
      '<div class="send-detail-row"><span class="send-detail-label">Recipient</span><span class="send-detail-value">' + escapeHtml(clientEmail || 'Client email') + '</span></div>';
  }

  // Show modal
  openModal('sendContractModal');
}

// Close send contract modal
function closeSendModal(){
  closeModal('sendContractModal');
  pendingSendContract = null;
}

// Confirm and send contract
function confirmSendContract(){
  if(!pendingSendContract) return;

  var contractId = pendingSendContract.contractId;
  var leadRecordId = pendingSendContract.leadRecordId;
  closeSendModal();

  showLoading('Sending contract...');
  google.script.run
    .withSuccessHandler(function(res){
      hideLoading();
      if(res.success){
        showToast('Contract sent to ' + (res.email || 'client') + '!','success');
        loadContractsFolder(); // Refresh to show updated status
      } else {
        showToast('Error: ' + (res.error || 'Failed to send'),'error');
      }
    })
    .withFailureHandler(function(e){
      hideLoading();
      console.error('Send contract error:', e);
      showToast('Failed to send contract','error');
    })
    .sendContractEmail(contractId, leadRecordId);
}

function formatDateDisplay(dateStr){
  if(!dateStr) return '-';
  try {
    var d = new Date(dateStr);
    if(isNaN(d.getTime())) return dateStr;
    var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    return months[d.getMonth()] + ' ' + d.getDate() + ', ' + d.getFullYear();
  } catch(e){
    return dateStr;
  }
}

function markResearchNotFound(){if(!currentResearchItem)return;google.script.run.withSuccessHandler(function(res){if(res.success){showToast('Marked not found','info');currentResearchItem=null;document.getElementById('researchEmptyState').style.display='block';document.getElementById('researchDetail').style.display='none';loadResearchQueue();}}).withFailureHandler(handleError).updateResearchItem(currentResearchItem.rowIndex,{Research_Status:'Not Found'},currentUser?currentUser.name:'');}

function saveAndMoveToLeads(){if(!currentResearchItem)return;var data={Found_Name:document.getElementById('researchFoundName').value,Found_Company:document.getElementById('researchFoundCompany').value,Found_Email:document.getElementById('researchFoundEmail').value,Found_Phone:document.getElementById('researchFoundPhone').value,Research_Status:'Found',Moved_to_Leads:'Yes'};if(!data.Found_Name&&!data.Found_Email){showToast('Enter name or email','error');return;}showLoading('Creating lead...');google.script.run.withSuccessHandler(function(res){hideLoading();if(res.success){showToast('Lead created!','success');currentResearchItem=null;document.getElementById('researchEmptyState').style.display='block';document.getElementById('researchDetail').style.display='none';loadResearchQueue();}else showToast('Error: '+(res.error||'Unknown'),'error');}).withFailureHandler(function(e){hideLoading();handleError(e);}).moveResearchToLead(currentResearchItem.rowIndex,data,currentUser?currentUser.name:'');}

function switchModalTab(tab){document.querySelectorAll('.modal-tab').forEach(function(t){t.classList.toggle('active',t.dataset.tab===tab);});document.querySelectorAll('.tab-panel').forEach(function(p){p.classList.remove('active');});var panel=document.getElementById('tab'+tab.charAt(0).toUpperCase()+tab.slice(1));if(panel)panel.classList.add('active');}

function openModal(id){document.getElementById(id).classList.add('active');}
function closeModal(id){document.getElementById(id).classList.remove('active');}
function closeModalOnBackdrop(e,id){if(e.target.classList.contains('modal-backdrop'))closeModal(id);}
function toggleSidebar(){
  var sidebar = document.getElementById('sidebar');
  var overlay = document.getElementById('sidebarOverlay');
  if (sidebar.classList.contains('open')) {
    closeSidebar();
  } else {
    sidebar.classList.add('open');
    if (overlay) overlay.classList.add('visible');
    document.body.style.overflow = 'hidden';
  }
}

function closeSidebar() {
  var sidebar = document.getElementById('sidebar');
  var overlay = document.getElementById('sidebarOverlay');
  sidebar.classList.remove('open');
  if (overlay) overlay.classList.remove('visible');
  document.body.style.overflow = '';
}
function showToast(msg,type){var c=document.getElementById('toastContainer');var t=document.createElement('div');t.className='toast toast-'+(type||'info');t.innerHTML='<span class="toast-message">'+escapeHtml(msg)+'</span>';c.appendChild(t);setTimeout(function(){t.remove();},4000);}
function handleError(e){console.error(e);showToast('An error occurred','error');}
function getInitials(name){if(!name)return'U';var p=name.split(' ');return p.length>=2?(p[0][0]+p[1][0]).toUpperCase():name.substring(0,2).toUpperCase();}
function escapeHtml(t){if(!t)return'';var d=document.createElement('div');d.textContent=t;return d.innerHTML;}
function formatCurrency(v){if(!v)return'-';var n=parseFloat(String(v).replace(/[^0-9.-]/g,''));return isNaN(n)?'-':'$'+n.toLocaleString('en-US',{minimumFractionDigits:0,maximumFractionDigits:0});}
function formatDate(v){if(!v)return'-';try{var d=new Date(v);return isNaN(d.getTime())?v:d.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});}catch(e){return v;}}
function formatDateForInput(v){if(!v)return'';try{var d=new Date(v);return isNaN(d.getTime())?'':d.toISOString().split('T')[0];}catch(e){return'';}}
function formatDateLong(v){
  if(!v) return '-';
  // If already formatted as "Mon D, YYYY" from server, return as-is
  if(typeof v === 'string' && v.match(/^[A-Z][a-z]{2}\s+\d{1,2},\s+\d{4}$/)) return v;
  // For M/D/YYYY format, parse without timezone issues
  if(typeof v === 'string' && v.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)){
    var parts = v.split('/');
    var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    return months[parseInt(parts[0])-1]+' '+parseInt(parts[1])+', '+parts[2];
  }
  try{
    var d = new Date(v);
    if(isNaN(d.getTime())) return v;
    var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    return months[d.getMonth()]+' '+d.getDate()+', '+d.getFullYear();
  }catch(e){return v;}
}
function getStatusClass(s){if(!s)return'cold';s=s.toLowerCase();if(s.indexOf('hot')>=0||s.indexOf('super')>=0)return'hot';if(s.indexOf('warm')>=0||s.indexOf('contract')>=0)return'warm';if(s.indexOf('booked')>=0)return'booked';if(s.indexOf('dead')>=0||s.indexOf('lost')>=0||s.indexOf('cancel')>=0||s.indexOf('slow')>=0)return'dead';return'cold';}
function debounce(fn,wait){var t;return function(){var ctx=this,args=arguments;clearTimeout(t);t=setTimeout(function(){fn.apply(ctx,args);},wait);};}

// Call History Functions
var callHistory=[];
var lastCallHistorySync = 0;

// Load call history with auto-sync (syncs if data is stale)
function loadCallHistoryWithSync(){
  var daysAgo = parseInt(document.getElementById('callsPeriod').value) || 1;
  var now = Date.now();
  var fiveMinutes = 5 * 60 * 1000;

  // Auto-sync if last sync was more than 5 minutes ago
  if (now - lastCallHistorySync > fiveMinutes) {
    showLoading('Loading calls from Dialpad...');
    google.script.run
      .withSuccessHandler(function(res){
        lastCallHistorySync = Date.now();
        // Now load the call history
        loadCallHistory();
      })
      .withFailureHandler(function(e){
        console.error('Auto-sync failed:', e);
        // Still try to load existing data
        loadCallHistory();
      })
      .syncDialpadCalls(daysAgo);
  } else {
    loadCallHistory();
  }
}

function loadCallHistory(){
  var daysAgo = parseInt(document.getElementById('callsPeriod').value) || 1;
  showLoading('Loading call history...');
  google.script.run
    .withSuccessHandler(function(res){
      hideLoading();
      if(res && res.success){
        callHistory = res.calls || [];
        renderCallHistory();
      } else {
        callHistory = [];
        renderCallHistory();
      }
    })
    .withFailureHandler(function(e){
      hideLoading();
      console.error('Call history error:', e);
      callHistory = [];
      renderCallHistory();
    })
    .getCallHistoryForWeb('', daysAgo);
}

function renderCallHistory(){
  var c = document.getElementById('callsList');
  var totalCalls = callHistory.length;
  var conversations = callHistory.filter(function(call){ return (parseInt(call.Duration_Sec) || 0) > 60; }).length;
  var totalDuration = callHistory.reduce(function(sum, call){ return sum + (parseInt(call.Duration_Sec) || 0); }, 0);
  var avgDuration = totalCalls > 0 ? Math.round(totalDuration / totalCalls / 60) : 0;
  var scoredCalls = callHistory.filter(function(call){ return call.AI_Score; });
  var avgScore = '-';
  if(scoredCalls.length > 0){
    var totalScore = scoredCalls.reduce(function(sum, call){
      var score = parseFloat(String(call.AI_Score || '').replace('%', '')) || 0;
      if(score < 1) score = score * 100;
      return sum + score;
    }, 0);
    avgScore = Math.round(totalScore / scoredCalls.length) + '%';
  }

  document.getElementById('callsTotalCount').textContent = totalCalls;
  document.getElementById('callsConversations').textContent = conversations;
  document.getElementById('callsAvgDuration').textContent = avgDuration + 'm';
  document.getElementById('callsAvgScore').textContent = avgScore;

  if(!callHistory.length){
    c.innerHTML = '<div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width:48px;height:48px;margin-bottom:16px;opacity:0.5;"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg><h3>No calls found</h3><p>Calls will appear here automatically</p></div>';
    return;
  }

  c.innerHTML = callHistory.map(function(call){
    var dir = call.Direction || 'outbound';
    var rawScore = parseFloat(String(call.AI_Score || '').replace('%', '')) || 0;
    var scoreNum = rawScore < 1 ? Math.round(rawScore * 100) : Math.round(rawScore);
    var scoreClass = scoreNum >= 70 ? 'high' : scoreNum >= 50 ? 'medium' : scoreNum > 0 ? 'low' : 'none';
    var scoreDisplay = scoreNum > 0 ? scoreNum + '%' : '-';
    var duration = call.Duration_Sec ? Math.floor(parseInt(call.Duration_Sec) / 60) + 'm ' + Math.round(parseInt(call.Duration_Sec) % 60) + 's' : '-';
    var dirIcon = dir === 'inbound'
      ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72"/><polyline points="7 17 17 7"/><polyline points="7 7 7 17 17 17"/></svg>'
      : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72"/><polyline points="17 7 7 17"/><polyline points="17 17 17 7 7 7"/></svg>';

    var html = '<div class="call-item">' +
      '<div class="call-direction ' + dir + '">' + dirIcon + '</div>' +
      '<div class="call-info">' +
        '<div class="call-contact">' + escapeHtml(call.Contact_Name || call.Contact_Phone || 'Unknown') + '</div>' +
        '<div class="call-meta"><span>' + escapeHtml(call.User || '-') + '</span><span>' + formatDate(call.Date) + '</span></div>' +
      '</div>' +
      '<div class="call-duration">' + duration + '</div>' +
      '<div class="call-score"><span class="call-score-badge ' + scoreClass + '">' + scoreDisplay + '</span></div>';

    if(call.AI_Summary){
      html += '<div class="call-transcript"><div class="call-ai-summary">' +
        '<div class="call-ai-summary-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><path d="M12 2a10 10 0 1 0 10 10H12V2z"/><path d="M12 2a10 10 0 0 1 10 10"/></svg>AI Summary</div>' +
        '<div class="call-ai-summary-text">' + escapeHtml(call.AI_Summary) + '</div>' +
      '</div></div>';
    }
    html += '</div>';
    return html;
  }).join('');
}

function formatCallDuration(seconds){if(!seconds)return'-';var m=Math.floor(seconds/60);var s=Math.round(seconds%60);return m+'m '+s+'s';}

// ============================================
// DAILY CHECK-IN FUNCTIONS
// ============================================

var selectedMood = '';

function selectMood(btn) {
  document.querySelectorAll('.mood-btn').forEach(function(b) {
    b.classList.remove('active');
  });
  btn.classList.add('active');
  selectedMood = btn.dataset.mood;
}

// EOD Premium UI Helper Functions
function updateScoreDisplay(val) {
  document.getElementById('scoreDisplay').textContent = val;
  document.getElementById('checkinScore').value = val;

  // Update descriptor
  var descriptor = 'Average Day';
  if (val <= 3) descriptor = 'Rough Day';
  else if (val <= 5) descriptor = 'Below Average';
  else if (val <= 7) descriptor = 'Okay Day';
  else if (val <= 10) descriptor = 'Good Day';
  else if (val <= 12) descriptor = 'Great Day';
  else if (val <= 14) descriptor = 'Excellent Day';
  else descriptor = 'Outstanding!';

  document.getElementById('scoreDescriptor').textContent = descriptor;
}

function selectPill(btn, inputId) {
  // Remove active from siblings
  btn.parentElement.querySelectorAll('.eod-pill').forEach(function(p) {
    p.classList.remove('active');
  });
  // Set active
  btn.classList.add('active');
  // Set hidden input value
  document.getElementById(inputId).value = btn.dataset.value;
}

function initEodGreeting() {
  var hour = new Date().getHours();
  var greeting = 'Good evening';
  if (hour < 12) greeting = 'Good morning';
  else if (hour < 17) greeting = 'Good afternoon';

  var greetingEl = document.getElementById('eodGreeting');
  if (greetingEl) greetingEl.textContent = greeting + ',';

  var userNameEl = document.getElementById('eodUserName');
  if (userNameEl && currentUser) {
    userNameEl.textContent = currentUser.name.split(' ')[0];
  }
}

function loadCheckin() {
  var d = new Date();
  document.getElementById('checkinDate').textContent = d.toLocaleDateString('en-US', {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });

  // Initialize EOD greeting
  initEodGreeting();

  // Reset form fields
  selectedMood = '';
  document.querySelectorAll('.mood-btn').forEach(function(b) {
    b.classList.remove('active');
  });
  document.querySelectorAll('.eod-pill').forEach(function(p) {
    p.classList.remove('active');
  });
  document.getElementById('checkinCardone').value = '';
  document.getElementById('checkinRoleplay').value = '';
  document.getElementById('checkinBarkLeads').value = '0';
  document.getElementById('checkinRoadblocks').value = '';
  document.getElementById('checkinWins').value = '';
  document.getElementById('checkinClosePhrases').value = '';

  // Reset score slider
  var slider = document.getElementById('checkinScoreSlider');
  if (slider) {
    slider.value = 8;
    updateScoreDisplay(8);
  }
  
  google.script.run
    .withSuccessHandler(function(m) {
      document.getElementById('checkinCalls').textContent = m.Calls_Made || 0;
      document.getElementById('checkinConvos').textContent = m.Conversations || 0;
      document.getElementById('checkinFollowups').textContent = m.Followups_Sent || 0;
      document.getElementById('checkinUpgrades').textContent = m.Leads_Upgraded || 0;
      document.getElementById('checkinContracts').textContent = m.Contracts_Generated || 0;
      
      if (m.AI_Score) {
        document.getElementById('checkinAiScore').style.display = 'flex';
        document.getElementById('checkinAiScoreValue').textContent = m.AI_Score + '%';
      } else {
        document.getElementById('checkinAiScore').style.display = 'none';
      }
      
      if (m.Mood) {
        var moodBtn = document.querySelector('.mood-btn[data-mood="' + m.Mood + '"]');
        if (moodBtn) selectMood(moodBtn);
      }
      if (m.Roadblocks) document.getElementById('checkinRoadblocks').value = m.Roadblocks;
      if (m.Special_Notes) document.getElementById('checkinWins').value = m.Special_Notes;
    })
    .withFailureHandler(function(e) {
      console.error('Error loading checkin:', e);
    })
    .getTodayMetrics(currentUser ? currentUser.name : '');
}

function submitCheckin() {
  // Validate required fields
  var score = document.getElementById('checkinScore').value;
  var cardone = document.getElementById('checkinCardone').value;
  var roleplay = document.getElementById('checkinRoleplay').value;

  if (!score) {
    showToast('Please select your overall call score', 'error');
    return;
  }
  if (!cardone) {
    showToast('Please select Cardone U training time', 'error');
    return;
  }
  if (!roleplay) {
    showToast('Please select role play time', 'error');
    return;
  }

  var data = {
    callScore: score,
    cardoneTraining: cardone,
    roleplayTime: roleplay,
    barkLeadsFound: document.getElementById('checkinBarkLeads').value || '0',
    closePhrases: document.getElementById('checkinClosePhrases').value,
    roadblocks: document.getElementById('checkinRoadblocks').value,
    wins: document.getElementById('checkinWins').value
  };

  showLoading('Submitting check-in...');

  google.script.run
    .withSuccessHandler(function(res) {
      hideLoading();
      if (res.success) {
        showToast('Check-in submitted!', 'success');
        // Clear form
        document.getElementById('checkinScore').value = '';
        document.getElementById('checkinCardone').value = '';
        document.getElementById('checkinRoleplay').value = '';
        document.getElementById('checkinBarkLeads').value = '';
        document.getElementById('checkinClosePhrases').value = '';
        document.getElementById('checkinRoadblocks').value = '';
        document.getElementById('checkinWins').value = '';
      } else {
        showToast('Error: ' + (res.error || 'Unknown'), 'error');
      }
    })
    .withFailureHandler(function(e) {
      hideLoading();
      showToast('Failed to submit', 'error');
      console.error(e);
    })
    .submitCheckin(data, currentUser ? currentUser.name : '');
}

// ============================================
// ANALYTICS DASHBOARD FUNCTIONS
// ============================================

var analyticsData = null;

var currentAnalyticsPeriod = 'week';

function loadAnalytics() {
  showLoading('Loading analytics...');
  var startDate = document.getElementById('analyticsStartDate').value;
  var endDate = document.getElementById('analyticsEndDate').value;

  google.script.run
    .withSuccessHandler(function(data) {
      hideLoading();
      if (data) renderAnalytics(data);
      else showToast('Error loading analytics', 'error');
    })
    .withFailureHandler(function(err) {
      hideLoading();
      showToast('Error: ' + err.message, 'error');
    })
    .getAnalyticsDataWithRange(startDate || null, endDate || null, currentAnalyticsPeriod);
}

function setAnalyticsPeriod(period) {
  currentAnalyticsPeriod = period;
  document.querySelectorAll('.date-btn[data-period]').forEach(function(btn) {
    btn.classList.toggle('active', btn.dataset.period === period);
  });
  document.getElementById('analyticsStartDate').value = '';
  document.getElementById('analyticsEndDate').value = '';
  loadAnalytics();
}

function applyCustomDateRange() {
  var start = document.getElementById('analyticsStartDate').value;
  var end = document.getElementById('analyticsEndDate').value;
  if (!start || !end) { showToast('Select both dates', 'warning'); return; }
  currentAnalyticsPeriod = 'custom';
  document.querySelectorAll('.date-btn[data-period]').forEach(function(btn) { btn.classList.remove('active'); });
  loadAnalytics();
}

function renderAnalytics(data) {
  if (!data) return;
  var kpis = data.kpis || {}, funnel = data.funnel || {}, sources = data.sourceData || [], team = data.teamLeaderboard || [], trends = data.trends || [], email = data.emailStats || {}, bookings = data.recentBookings || [];

  // KPIs
  document.getElementById('analyticsPipeline').textContent = '$' + (kpis.pipeline ? kpis.pipeline.value.toLocaleString() : 0);
  document.getElementById('analyticsPipelineCount').textContent = (kpis.pipeline ? kpis.pipeline.count : 0) + ' leads';
  document.getElementById('analyticsHotValue').textContent = '$' + (kpis.hotLeads ? kpis.hotLeads.value.toLocaleString() : 0);
  document.getElementById('analyticsHotCount').textContent = (kpis.hotLeads ? kpis.hotLeads.count : 0) + ' hot';
  document.getElementById('analyticsBookedValue').textContent = '$' + (kpis.booked ? kpis.booked.value.toLocaleString() : 0);
  var bookedMeta = (kpis.booked ? kpis.booked.count : 0) + ' deals';
  if (kpis.booked && kpis.booked.change) bookedMeta += ' <span class="' + (kpis.booked.change > 0 ? 'change-up' : 'change-down') + '">' + (kpis.booked.change > 0 ? '↑' : '↓') + Math.abs(kpis.booked.change) + '%</span>';
  document.getElementById('analyticsBookedMeta').innerHTML = bookedMeta;
  document.getElementById('analyticsConversion').textContent = (kpis.conversionRate ? kpis.conversionRate.value : 0) + '%';

  // Funnel
  var funnelEl = document.getElementById('funnelContainer');
  var maxVal = funnel.totalValue || 1;
  funnelEl.innerHTML = [{l:'Total',c:funnel.total,v:funnel.totalValue,cl:'total'},{l:'Active',c:funnel.active,v:funnel.activeValue,cl:'active'},{l:'Hot',c:funnel.hot,v:funnel.hotValue,cl:'hot'},{l:'Booked',c:funnel.booked,v:funnel.bookedValue,cl:'booked'}].map(function(s){var p=Math.round((s.v/maxVal)*100);return'<div class="funnel-row"><div class="funnel-label">'+s.l+'</div><div class="funnel-stats"><strong>'+s.c+'</strong><span>$'+(s.v||0).toLocaleString()+'</span></div><div class="funnel-bar"><div class="funnel-fill '+s.cl+'" style="width:'+p+'%"></div></div></div>';}).join('');

  // Sources
  var sourcesEl = document.getElementById('sourcesList');
  var maxSrc = sources.length > 0 ? sources[0].value : 1;
  sourcesEl.innerHTML = sources.map(function(s){var p=Math.round((s.value/maxSrc)*100);return'<div class="source-row"><div class="source-name">'+s.name+'</div><div class="source-bar"><div class="source-fill" style="width:'+p+'%"></div></div><div class="source-value">$'+s.value.toLocaleString()+'</div></div>';}).join('') || '<div style="text-align:center;color:var(--text-muted)">No data</div>';

  // Leaderboard
  var colors = ['#6366f1','#8b5cf6','#ec4899','#f59e0b','#22c55e','#06b6d4'];
  document.getElementById('leaderboardBody').innerHTML = team.map(function(m,i){var rc=i===0?'gold':i===1?'silver':i===2?'bronze':'default';var init=(m.name||'U').split(' ').map(function(n){return n[0];}).join('').substring(0,2).toUpperCase();return'<tr><td><span class="rank-badge '+rc+'">#'+(i+1)+'</span></td><td><div class="member-cell"><div class="member-avatar" style="background:'+colors[i%6]+'">'+init+'</div>'+m.name+'</div></td><td class="booked-value">'+(m.bookedValue>0?'$'+m.bookedValue.toLocaleString():'-')+'</td><td>'+(m.bookedCount||0)+'</td><td>$'+(m.pipelineValue||0).toLocaleString()+'</td><td>'+(m.calls||0)+'</td><td>'+(m.conversations||0)+'</td><td class="points-value">'+(m.points||0)+'</td></tr>';}).join('') || '<tr><td colspan="8" style="text-align:center;color:var(--text-muted)">No data</td></tr>';

  // Chart
  renderTrendsChart(trends);

  // Email
  document.getElementById('emailsSent').textContent = email.sent || 0;
  document.getElementById('emailsOpened').textContent = email.opened || 0;
  document.getElementById('emailOpenRate').textContent = (email.openRate || 0) + '%';
  document.getElementById('bestSubject').textContent = email.bestSubject || 'N/A';

  // Bookings
  document.getElementById('recentBookingsList').innerHTML = bookings.map(function(b){return'<div class="booking-item"><div><div class="booking-event">'+(b.event||'Event')+'</div><div class="booking-meta">'+(b.contact||'')+' • '+(b.owner||'')+'</div></div><div style="text-align:right"><div class="booking-value">$'+(b.value||0).toLocaleString()+'</div><div class="booking-date">'+(b.date?new Date(b.date).toLocaleDateString():'')+'</div></div></div>';}).join('') || '<div style="text-align:center;color:var(--text-muted)">No bookings</div>';
}

// ============================================
// LINE CHART - ACTIVITY TRENDS
// ============================================

function renderTrendsChart(trends) {
  var container = document.getElementById('trendsChart');
  var summaryEl = document.getElementById('chartSummary');
  if (!container) return;

  if (!trends || !trends.length) {
    container.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:40px">No data</div>';
    if (summaryEl) summaryEl.innerHTML = '';
    return;
  }

  var w = container.clientWidth || 700, h = 160, p = {t:20,r:30,b:30,l:30};
  var cw = w - p.l - p.r, ch = h - p.t - p.b;
  var maxV = Math.max(Math.max.apply(null, trends.map(function(t){return t.calls||0;})), Math.max.apply(null, trends.map(function(t){return t.conversations||0;})), 5);
  var xS = cw / Math.max(trends.length - 1, 1);

  var callsPts = trends.map(function(t,i){return(p.l+i*xS)+','+(p.t+ch-((t.calls||0)/maxV)*ch);}).join(' ');
  var convosPts = trends.map(function(t,i){return(p.l+i*xS)+','+(p.t+ch-((t.conversations||0)/maxV)*ch);}).join(' ');
  var xLbls = trends.map(function(t,i){var d=new Date(t.date);return'<text x="'+(p.l+i*xS)+'" y="'+(h-8)+'" text-anchor="middle" fill="#71717a" font-size="10">'+(d.getMonth()+1)+'/'+d.getDate()+'</text>';}).join('');
  var dots = trends.map(function(t,i){var x=p.l+i*xS;return'<circle cx="'+x+'" cy="'+(p.t+ch-((t.calls||0)/maxV)*ch)+'" r="4" fill="#6366f1"/><circle cx="'+x+'" cy="'+(p.t+ch-((t.conversations||0)/maxV)*ch)+'" r="4" fill="#22c55e"/>';}).join('');

  container.innerHTML = '<svg viewBox="0 0 '+w+' '+h+'">'+xLbls+'<polyline points="'+callsPts+'" fill="none" stroke="#6366f1" stroke-width="2"/><polyline points="'+convosPts+'" fill="none" stroke="#22c55e" stroke-width="2"/>'+dots+'</svg>';

  var totC = trends.reduce(function(s,t){return s+(t.calls||0);},0);
  var totV = trends.reduce(function(s,t){return s+(t.conversations||0);},0);
  if (summaryEl) {
    summaryEl.innerHTML = '<div class="chart-summary-item"><div class="chart-summary-value">'+totC+'</div><div class="chart-summary-label">Calls</div></div><div class="chart-summary-item"><div class="chart-summary-value">'+totV+'</div><div class="chart-summary-label">Convos</div></div><div class="chart-summary-item"><div class="chart-summary-value">'+Math.round(totC/Math.max(trends.length,1))+'</div><div class="chart-summary-label">Avg/Day</div></div>';
  }
}

function formatK(num) {
  if (!num) return '0';
  if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
  if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
  return num.toString();
}

// ============================================
// PHASE 1 - ADVANCED SEARCH (N5)
// ============================================

function toggleAdvancedSearch(){
  var panel=document.getElementById('advancedSearchPanel');
  if(panel){
    panel.classList.toggle('active');
    if(panel.classList.contains('active')){
      populateAdvancedSearchDropdowns();
      // Switch to list view if on dashboard
      if(currentView==='dashboard'){
        switchView('leads');
        setTimeout(function(){
          document.getElementById('advancedSearchPanel').classList.add('active');
        },100);
      }
    }
  }
}

function populateAdvancedSearchDropdowns(){
  // Populate state dropdown
  var stateEl=document.getElementById('advSearchState');
  if(stateEl&&dropdownOptions.State){
    stateEl.innerHTML='<option value="">Any State</option>'+dropdownOptions.State.map(function(v){
      return'<option value="'+escapeHtml(v)+'">'+escapeHtml(v)+'</option>';
    }).join('');
  }

  // Populate category dropdown
  var catEl=document.getElementById('advSearchCategory');
  if(catEl&&dropdownOptions.Category){
    catEl.innerHTML='<option value="">Any Category</option>'+dropdownOptions.Category.map(function(v){
      return'<option value="'+escapeHtml(v)+'">'+escapeHtml(v)+'</option>';
    }).join('');
  }

  // Populate What Did We Pitch dropdown
  var pitchEl=document.getElementById('advSearchWhatPitched');
  if(pitchEl&&dropdownOptions.What_Pitched){
    pitchEl.innerHTML='<option value="">Any Pitch</option>'+dropdownOptions.What_Pitched.map(function(v){
      return'<option value="'+escapeHtml(v)+'">'+escapeHtml(v)+'</option>';
    }).join('');
  }

  // Populate status dropdown
  var statusEl=document.getElementById('advSearchStatus');
  if(statusEl&&dropdownOptions.Lead_Status){
    statusEl.innerHTML='<option value="">Any Status</option>'+dropdownOptions.Lead_Status.map(function(v){
      return'<option value="'+escapeHtml(v)+'">'+escapeHtml(v)+'</option>';
    }).join('');
  }

  // Populate owner dropdown
  var ownerEl=document.getElementById('advSearchOwner');
  if(ownerEl&&dropdownOptions.Lead_Owner){
    ownerEl.innerHTML='<option value="">Any Owner</option>'+dropdownOptions.Lead_Owner.map(function(v){
      return'<option value="'+escapeHtml(v)+'">'+escapeHtml(v)+'</option>';
    }).join('');
  }
}

function runAdvancedSearch(){
  var filters={
    category:document.getElementById('advSearchCategory').value,
    whatPitched:document.getElementById('advSearchWhatPitched').value,
    eventMonth:document.getElementById('advSearchMonth').value,
    state:document.getElementById('advSearchState').value,
    eventDateFrom:document.getElementById('advSearchEventDateFrom').value,
    eventDateTo:document.getElementById('advSearchEventDateTo').value,
    followupFrom:document.getElementById('advSearchFollowupFrom').value,
    followupTo:document.getElementById('advSearchFollowupTo').value,
    status:document.getElementById('advSearchStatus').value,
    owner:document.getElementById('advSearchOwner').value,
    quoteMin:parseFloat(document.getElementById('advSearchQuoteMin').value)||null,
    quoteMax:parseFloat(document.getElementById('advSearchQuoteMax').value)||null
  };

  showLoading('Searching...');

  google.script.run.withSuccessHandler(function(results){
    hideLoading();
    allRecords=results||[];
    filteredRecords=allRecords;
    renderTable();
    document.getElementById('advancedSearchPanel').classList.remove('active');
    showToast('Found '+allRecords.length+' leads','success');
  }).withFailureHandler(function(e){
    hideLoading();
    console.error(e);
    showToast('Search failed','error');
  }).advancedSearchLeads(filters,currentUser?currentUser.name:'');
}

function clearAdvancedSearch(){
  document.getElementById('advSearchCategory').value='';
  document.getElementById('advSearchWhatPitched').value='';
  document.getElementById('advSearchMonth').value='';
  document.getElementById('advSearchState').value='';
  document.getElementById('advSearchEventDateFrom').value='';
  document.getElementById('advSearchEventDateTo').value='';
  document.getElementById('advSearchFollowupFrom').value='';
  document.getElementById('advSearchFollowupTo').value='';
  document.getElementById('advSearchStatus').value='';
  document.getElementById('advSearchOwner').value='';
  document.getElementById('advSearchQuoteMin').value='';
  document.getElementById('advSearchQuoteMax').value='';
  document.getElementById('advSearchSource').value='';
}

// ============================================
// PHASE 1 - BULK MOVE STORAGE TO ACTIVE (A4)
// ============================================

function openBulkMoveModal(){
  bulkMoveSelected.clear();
  document.getElementById('bulkMoveSelectedCount').textContent='0 selected';
  document.getElementById('bulkMoveList').innerHTML='';
  document.getElementById('bulkMoveEmpty').textContent='Loading storage leads...';
  openModal('bulkMoveModal');

  google.script.run.withSuccessHandler(function(leads){
    bulkMoveLeads=leads||[];
    renderBulkMoveList();
  }).withFailureHandler(function(e){
    console.error(e);
    document.getElementById('bulkMoveEmpty').textContent='Failed to load storage leads';
  }).getLeads('storage',currentUser?currentUser.name:'');
}

function renderBulkMoveList(){
  var listEl=document.getElementById('bulkMoveList');
  var emptyEl=document.getElementById('bulkMoveEmpty');

  if(!bulkMoveLeads.length){
    listEl.innerHTML='';
    emptyEl.textContent='No leads in Storage';
    emptyEl.style.display='block';
    return;
  }

  emptyEl.style.display='none';
  listEl.innerHTML=bulkMoveLeads.map(function(lead){
    var checked=bulkMoveSelected.has(lead.rowIndex)?'checked':'';
    return'<div class="bulk-move-item" style="display:flex;align-items:center;gap:12px;padding:12px;border-bottom:1px solid var(--border-primary);">'+
      '<input type="checkbox" '+checked+' onchange="toggleBulkMoveSelect('+lead.rowIndex+',this.checked)" style="width:18px;height:18px;">'+
      '<div style="flex:1;">'+
        '<div style="font-weight:500;color:var(--text-primary);">'+escapeHtml(lead.Contact_Person||'Unknown')+'</div>'+
        '<div style="font-size:0.8125rem;color:var(--text-muted);">'+escapeHtml(lead.Event_Name||'-')+' | '+escapeHtml(lead.Lead_Status||'-')+'</div>'+
      '</div>'+
      '<div style="text-align:right;">'+
        '<div style="font-weight:600;">'+formatCurrency(lead.Active_Quote)+'</div>'+
        '<div style="font-size:0.75rem;color:var(--text-muted);">'+formatDate(lead.Date_Last_Touch)+'</div>'+
      '</div>'+
    '</div>';
  }).join('');
}

function toggleBulkMoveSelect(rowIndex,checked){
  if(checked)bulkMoveSelected.add(rowIndex);
  else bulkMoveSelected.delete(rowIndex);
  document.getElementById('bulkMoveSelectedCount').textContent=bulkMoveSelected.size+' selected';
}

function executeBulkMove(){
  if(bulkMoveSelected.size===0){
    showToast('No leads selected','error');
    return;
  }

  var rowIndexes=Array.from(bulkMoveSelected);
  showLoading('Moving '+rowIndexes.length+' leads to Active...');

  google.script.run.withSuccessHandler(function(result){
    hideLoading();
    if(result.success){
      showToast('Moved '+result.moved+' leads to Active!','success');
      closeModal('bulkMoveModal');
      loadDashboard();
    }else{
      showToast('Error: '+(result.error||'Unknown'),'error');
    }
  }).withFailureHandler(function(e){
    hideLoading();
    console.error(e);
    showToast('Failed to move leads','error');
  }).bulkMoveStorageToActive(rowIndexes,currentUser?currentUser.name:'');
}

// ============================================
// PHASE 1 - OPEN ADD LEAD WITH DUPLICATE CHECK
// ============================================

function openAddLead(){
  document.getElementById('modalTitle').textContent='Add Lead';
  document.getElementById('displayRecordId').textContent='';
  document.getElementById('leadForm').reset();
  document.getElementById('leadRowIndex').value='';
  document.getElementById('fieldLeadOwner').value=currentUser?currentUser.name:'';
  hideDuplicateWarning();
  hideValidationErrors();
  switchModalTab('details');
  openModal('leadModal');

  // Add duplicate check listener to email and phone fields
  var emailField=document.getElementById('fieldEmail');
  var phoneField=document.getElementById('fieldPhoneNumber');

  var checkDuplicates=debounce(function(){
    var email=emailField.value;
    var phone=phoneField.value;
    if(email||phone){
      checkDuplicatesBeforeSave(email,phone,function(hasDuplicates){
        // Warning is shown/hidden by checkDuplicatesBeforeSave
      });
    }
  },500);

  emailField.addEventListener('blur',checkDuplicates);
  phoneField.addEventListener('blur',checkDuplicates);
}

// ============================================
// PHASE 2 - EMAIL ANALYTICS
// ============================================

function renderEmailAnalytics(data) {
  if (!data) {
    data = { totalSent: 0, totalOpened: 0, openRate: 0, bestSubject: null, userBreakdown: [] };
  }

  document.getElementById('emailTotalSent').textContent = data.totalSent || 0;
  document.getElementById('emailTotalOpened').textContent = data.totalOpened || 0;
  document.getElementById('emailOpenRate').textContent = (data.openRate || 0) + '%';
  document.getElementById('emailBestSubject').textContent = data.bestSubject || 'No data yet';

  var tbody = document.getElementById('emailTeamBreakdown');
  if (!tbody) return;

  if (!data.userBreakdown || data.userBreakdown.length === 0) {
    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--text-muted);padding:20px;">No email data for this period</td></tr>';
    return;
  }

  tbody.innerHTML = data.userBreakdown.map(function(u) {
    var rate = u.sent > 0 ? Math.round((u.opened / u.sent) * 100) : 0;
    var rateClass = rate >= 40 ? 'high' : (rate >= 20 ? 'medium' : 'low');
    return '<tr>' +
      '<td>' + escapeHtml(u.userName || 'Unknown') + '</td>' +
      '<td style="text-align:center;">' + (u.sent || 0) + '</td>' +
      '<td style="text-align:center;">' + (u.opened || 0) + '</td>' +
      '<td style="text-align:center;"><span class="email-open-rate ' + rateClass + '">' + rate + '%</span></td>' +
    '</tr>';
  }).join('');
}

// ============================================
// PHASE 2 - ACTIVITY LOG SYSTEM
// ============================================

var currentLeadActivities = [];
var currentActivityFilter = 'all';

function loadLeadActivities(leadId) {
  if (!leadId) {
    document.getElementById('activityTimeline').innerHTML = '<div class="activity-empty">No Record ID available</div>';
    document.getElementById('activityCount').textContent = '0';
    return;
  }

  document.getElementById('activityTimeline').innerHTML = '<div class="activity-loading">Loading activities...</div>';

  google.script.run.withSuccessHandler(function(activities) {
    currentLeadActivities = activities || [];
    document.getElementById('activityCount').textContent = currentLeadActivities.length;
    renderActivities(currentLeadActivities);
  }).withFailureHandler(function(e) {
    console.error('Error loading activities:', e);
    document.getElementById('activityTimeline').innerHTML = '<div class="activity-empty">Error loading activities</div>';
  }).getLeadActivities(leadId);
}

function renderActivities(activities) {
  var container = document.getElementById('activityTimeline');

  if (!activities || activities.length === 0) {
    container.innerHTML = '<div class="activity-empty">No activity recorded yet</div>';
    return;
  }

  // Apply filter
  var filtered = currentActivityFilter === 'all'
    ? activities
    : activities.filter(function(a) { return a.Type === currentActivityFilter; });

  if (filtered.length === 0) {
    container.innerHTML = '<div class="activity-empty">No ' + currentActivityFilter.replace('_', ' ').toLowerCase() + ' activities</div>';
    return;
  }

  var html = filtered.map(function(activity) {
    var dateStr = formatActivityDate(activity.Date);
    var changeHtml = '';

    if (activity.Old_Value && activity.New_Value) {
      changeHtml = '<div class="activity-change"><span class="old">' + escapeHtml(activity.Old_Value) + '</span><span class="arrow">→</span><span class="new">' + escapeHtml(activity.New_Value) + '</span></div>';
    }

    return '<div class="activity-item type-' + activity.Type + '">' +
      '<div class="activity-header-row">' +
        '<span class="activity-title">' + escapeHtml(activity.Title || activity.Type) + '</span>' +
        '<span class="activity-date">' + dateStr + '</span>' +
      '</div>' +
      '<div class="activity-meta">by ' + escapeHtml(activity.User_Name || 'System') + '</div>' +
      (activity.Description ? '<div class="activity-description">' + escapeHtml(activity.Description) + '</div>' : '') +
      changeHtml +
    '</div>';
  }).join('');

  container.innerHTML = html;
}

function filterActivities() {
  currentActivityFilter = document.getElementById('activityFilter').value;
  renderActivities(currentLeadActivities);
}

function formatActivityDate(dateStr) {
  if (!dateStr) return '';
  try {
    var d = new Date(dateStr);
    var now = new Date();
    var diffMs = now - d;
    var diffMins = Math.floor(diffMs / 60000);
    var diffHours = Math.floor(diffMs / 3600000);
    var diffDays = Math.floor(diffMs / 86400000);

    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return diffMins + 'm ago';
    if (diffHours < 24) return diffHours + 'h ago';
    if (diffDays < 7) return diffDays + 'd ago';

    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: d.getFullYear() !== now.getFullYear() ? 'numeric' : undefined });
  } catch (e) {
    return dateStr;
  }
}

function escapeHtml(str) {
  if (!str) return '';
  var div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function logManualActivity() {
  var leadId = document.getElementById('fieldRecordId').value;
  if (!leadId) {
    showToast('Please save lead first', 'error');
    return;
  }

  var activityType = prompt('Activity type (Call, Email, Note, Follow_Up):');
  if (!activityType) return;

  var title = prompt('Activity title:');
  if (!title) return;

  var description = prompt('Description (optional):') || '';

  var activity = {
    Lead_Record_ID: leadId,
    User_ID: currentUser ? currentUser.User_ID : '',
    User_Name: currentUser ? currentUser.name : 'Unknown',
    Type: activityType,
    Title: title,
    Description: description
  };

  google.script.run.withSuccessHandler(function(result) {
    if (result && result.success) {
      showToast('Activity logged', 'success');
      loadLeadActivities(leadId);
    } else {
      showToast('Error logging activity', 'error');
    }
  }).withFailureHandler(function(e) {
    console.error(e);
    showToast('Error logging activity', 'error');
  }).logActivity(activity);
}

// ============================================
// PHASE 2 - RESEARCH WORKFLOW IMPROVEMENTS
// ============================================

var researchTimerInterval = null;
var researchTimerSeconds = 0;
var currentResearchData = null;

function toggleResearchTimer() {
  var display = document.getElementById('timerDisplay');
  var btn = document.getElementById('timerStartBtn');

  if (researchTimerInterval) {
    // Stop timer
    clearInterval(researchTimerInterval);
    researchTimerInterval = null;
    display.classList.remove('running');
    btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><polygon points="5 3 19 12 5 21 5 3"/></svg>';
    btn.title = 'Start timer';
  } else {
    // Start timer
    researchTimerInterval = setInterval(function() {
      researchTimerSeconds++;
      var mins = Math.floor(researchTimerSeconds / 60);
      var secs = researchTimerSeconds % 60;
      display.textContent = (mins < 10 ? '0' : '') + mins + ':' + (secs < 10 ? '0' : '') + secs;
    }, 1000);
    display.classList.add('running');
    btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>';
    btn.title = 'Pause timer';
  }
}

function resetResearchTimer() {
  if (researchTimerInterval) {
    clearInterval(researchTimerInterval);
    researchTimerInterval = null;
  }
  researchTimerSeconds = 0;
  var display = document.getElementById('timerDisplay');
  if (display) {
    display.textContent = '00:00';
    display.classList.remove('running');
  }
  var btn = document.getElementById('timerStartBtn');
  if (btn) {
    btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><polygon points="5 3 19 12 5 21 5 3"/></svg>';
    btn.title = 'Start timer';
  }
}

function openSearch(type) {
  if (!currentResearchData) {
    showToast('No research data loaded', 'error');
    return;
  }

  var query = '';
  var city = currentResearchData.City || '';
  var eventType = currentResearchData.Event_Type || currentResearchData.Looking_For || '';
  var name = document.getElementById('researchFoundName').value || '';

  switch (type) {
    case 'linkedin':
      query = name ? name + ' ' + city : city + ' ' + eventType;
      window.open('https://www.linkedin.com/search/results/all/?keywords=' + encodeURIComponent(query), '_blank');
      break;
    case 'google':
      query = name ? name + ' ' + city : city + ' ' + eventType + ' contact';
      window.open('https://www.google.com/search?q=' + encodeURIComponent(query), '_blank');
      break;
    case 'facebook':
      query = name ? name + ' ' + city : city + ' ' + eventType;
      window.open('https://www.facebook.com/search/top/?q=' + encodeURIComponent(query), '_blank');
      break;
    case 'maps':
      query = city;
      window.open('https://www.google.com/maps/search/' + encodeURIComponent(query), '_blank');
      break;
  }
}

function copyForSearch() {
  if (!currentResearchData) {
    showToast('No research data loaded', 'error');
    return;
  }

  var text = [
    currentResearchData.Looking_For || '',
    currentResearchData.City || '',
    currentResearchData.Event_Type || '',
    currentResearchData.Message || ''
  ].filter(function(s) { return s; }).join('\n');

  navigator.clipboard.writeText(text).then(function() {
    showToast('Copied to clipboard', 'success');
  }).catch(function() {
    showToast('Failed to copy', 'error');
  });
}

function extractFromLinkedIn() {
  var urlInput = document.getElementById('linkedinUrlInput');
  var url = urlInput.value.trim();

  if (!url) {
    showToast('Please paste a LinkedIn URL', 'error');
    return;
  }

  if (!url.includes('linkedin.com')) {
    showToast('Not a valid LinkedIn URL', 'error');
    return;
  }

  // Extract name from URL pattern: linkedin.com/in/firstname-lastname
  var match = url.match(/linkedin\.com\/in\/([^\/\?]+)/);
  if (match) {
    var slug = match[1];
    // Convert slug to name: "john-doe-abc123" -> "John Doe"
    var nameParts = slug.split('-').filter(function(p) {
      return p && !/^\d+$/.test(p) && p.length > 1;
    }).slice(0, 2);

    if (nameParts.length > 0) {
      var extractedName = nameParts.map(function(p) {
        return p.charAt(0).toUpperCase() + p.slice(1).toLowerCase();
      }).join(' ');

      document.getElementById('researchFoundName').value = extractedName;
      showToast('Extracted name: ' + extractedName, 'success');
      urlInput.value = '';
    } else {
      showToast('Could not extract name from URL', 'warning');
    }
  } else {
    showToast('Could not parse LinkedIn URL', 'error');
  }
}

</script>
